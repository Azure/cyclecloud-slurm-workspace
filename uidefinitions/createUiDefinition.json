{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "basics": {
        "description": "Version **2025.12.01**: [Release Notes](https://learn.microsoft.com/azure/cyclecloud/release-notes/ccws/release-notes)",
        "resourceGroup": {
          "visible": false
        },
        "location": {
          "label": "Region in which to deploy resources",
          "toolTip": "Select the region in which to deploy resources",
          "visible": true
        }
      }
    },
    "basics": [
      {
        "name": "rgApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/resourcegroups?api-version=2021-04-01')]"
        }
      },
      {
        "name": "anfAvailabilityZonesApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.NetApp/locations/',location(),'/regionInfos/default?api-version=2024-09-01')]"
        }
      },
      {
        "name": "amlAvailabilityZonesApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/providers/Microsoft.StorageCache/skus?api-version=2024-03-01')]"
        }
      },
      {
        "name": "locationInfoApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/locations?api-version=2022-12-01')]"
        }
      },
      {
        "name": "newexisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group options",
        "defaultValue": "Create a new resource group",
        "toolTip": "Create a new resource group or use an existing one",
        "constraints": {
          "allowedValues": [
            {
              "label": "Create a new resource group",
              "value": "new"
            },
            {
              "label": "Use an existing resource group",
              "value": "existing"
            }
          ],
          "required": true
        },
        "visible": true
      },
      {
        "name": "rgExisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group",
        "toolTip": "Select or search for an existing resource group in selected region",
        "filter": true,
        "constraints": {
          "allowedValues": "[map(filter(basics('rgApi').value, (item) => equals(item.location,location())), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'existing')]"
      },
      {
        "name": "rgNew",
        "type": "Microsoft.Common.TextBox",
        "label": "Resource group",
        "toolTip": "Resource will be created in region selected above",
        "constraints": {
          "validations": [
            {
              "regex": "^(?!.*\\.$)[a-zA-Z0-9_().-À-ÖØ-öø-ſ]?[a-zA-Z0-9_().-À-ÖØ-öø-ſ]{0,88}$",
              "message": "Resource group names may only include alphanumeric, underscore, parentheses, hyphens, and periods (except at end)."
            }
          ],
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'new')]"
      },
      {
        "name": "CycleCloudVmName",
        "type": "Microsoft.Common.TextBox",
        "label": "CycleCloud VM Name",
        "defaultValue": "ccw-cyclecloud-vm",
        "toolTip": "Name for the CycleCloud VM",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-zA-Z0-9.-]{1,64}$",
              "message": "Azure Linux VM names must be between 1 and 64 characters long and contain only letters, numbers, '.', and '-'."
            },
            {
              "regex": "^(?![.-])(.*)(?<![.-])$",
              "message": "Azure resource names may neither begin nor end with '.' or '-'."
            }
          ]
        },
        "visible": true
      },
      {
        "name": "CycleCloudVmSize",
        "type": "Microsoft.Compute.SizeSelector",
        "label": "CycleCloud VM Size",
        "toolTip": "Select a size for the CycleCloud VM",
        "recommendedSizes": [
          "Standard_D4as_v5",
          "Standard_D4s_v5",
          "Standard_D4as_v4",
          "Standard_D4s_v4"
        ],
        "constraints": {
          "excludedSizes": [
            "Standard_D16pds_v5",
            "Standard_D16pds_v6",
            "Standard_D16plds_v5",
            "Standard_D16plds_v6",
            "Standard_D16pls_v5",
            "Standard_D16pls_v6",
            "Standard_D16ps_v5",
            "Standard_D16ps_v6",
            "Standard_D2pds_v5",
            "Standard_D2pds_v6",
            "Standard_D2plds_v5",
            "Standard_D2plds_v6",
            "Standard_D2pls_v5",
            "Standard_D2pls_v6",
            "Standard_D2ps_v5",
            "Standard_D2ps_v6",
            "Standard_D32pds_v5",
            "Standard_D32pds_v6",
            "Standard_D32plds_v5",
            "Standard_D32plds_v6",
            "Standard_D32pls_v5",
            "Standard_D32pls_v6",
            "Standard_D32ps_v5",
            "Standard_D32ps_v6",
            "Standard_D48pds_v5",
            "Standard_D48pds_v6",
            "Standard_D48plds_v5",
            "Standard_D48plds_v6",
            "Standard_D48pls_v5",
            "Standard_D48pls_v6",
            "Standard_D48ps_v5",
            "Standard_D48ps_v6",
            "Standard_D4pds_v5",
            "Standard_D4pds_v6",
            "Standard_D4plds_v5",
            "Standard_D4plds_v6",
            "Standard_D4pls_v5",
            "Standard_D4pls_v6",
            "Standard_D4ps_v5",
            "Standard_D4ps_v6",
            "Standard_D64pds_v5",
            "Standard_D64pds_v6",
            "Standard_D64plds_v5",
            "Standard_D64plds_v6",
            "Standard_D64pls_v5",
            "Standard_D64pls_v6",
            "Standard_D64ps_v5",
            "Standard_D64ps_v6",
            "Standard_D8pds_v5",
            "Standard_D8pds_v6",
            "Standard_D8plds_v5",
            "Standard_D8plds_v6",
            "Standard_D8pls_v5",
            "Standard_D8pls_v6",
            "Standard_D8ps_v5",
            "Standard_D8ps_v6",
            "Standard_D96pds_v6",
            "Standard_D96plds_v6",
            "Standard_D96pls_v6",
            "Standard_D96ps_v6",
            "Standard_E16pds_v5",
            "Standard_E16pds_v6",
            "Standard_E16ps_v5",
            "Standard_E16ps_v6",
            "Standard_E20pds_v5",
            "Standard_E20ps_v5",
            "Standard_E2pds_v5",
            "Standard_E2pds_v6",
            "Standard_E2ps_v5",
            "Standard_E2ps_v6",
            "Standard_E32pds_v5",
            "Standard_E32pds_v6",
            "Standard_E32ps_v5",
            "Standard_E32ps_v6",
            "Standard_E48pds_v6",
            "Standard_E48ps_v6",
            "Standard_E4pds_v5",
            "Standard_E4pds_v6",
            "Standard_E4ps_v5",
            "Standard_E4ps_v6",
            "Standard_E64pds_v6",
            "Standard_E64ps_v6",
            "Standard_E8pds_v5",
            "Standard_E8pds_v6",
            "Standard_E8ps_v5",
            "Standard_E8ps_v6",
            "Standard_E96pds_v6",
            "Standard_E96ps_v6",
            "Standard_A1_v2",
            "Standard_A2_v2",
            "Standard_A2m_v2",
            "Standard_A4_v2",
            "Standard_A4m_v2",
            "Standard_A8_v2",
            "Standard_A8m_v2",
            "Standard_D1",
            "Standard_D11",
            "Standard_D11_v2",
            "Standard_D12",
            "Standard_D12_v2",
            "Standard_D13",
            "Standard_D13_v2",
            "Standard_D14",
            "Standard_D14_v2",
            "Standard_D15_v2",
            "Standard_D16_v3",
            "Standard_D1_v2",
            "Standard_D2",
            "Standard_D2_v2",
            "Standard_D2_v3",
            "Standard_D3",
            "Standard_D32_v3",
            "Standard_D3_v2",
            "Standard_D4",
            "Standard_D48_v3",
            "Standard_D4_v2",
            "Standard_D4_v3",
            "Standard_D5_v2",
            "Standard_D64_v3",
            "Standard_D8_v3",
            "Standard_E16_v3",
            "Standard_E20_v3",
            "Standard_E2_v3",
            "Standard_E32_v3",
            "Standard_E48_v3",
            "Standard_E4_v3",
            "Standard_E64_v3",
            "Standard_E64i_v3",
            "Standard_E8_v3",
            "Standard_F1",
            "Standard_F16",
            "Standard_F2",
            "Standard_F4",
            "Standard_F8",
            "Standard_D4as_v6",
            "Standard_D2als_v6",
            "Standard_D4als_v6",
            "Standard_D8als_v6",
            "Standard_D16als_v6",
            "Standard_D32als_v6",
            "Standard_D48als_v6",
            "Standard_D64als_v6",
            "Standard_D96als_v6"
          ]
        },
        "options": {
          "hideDiskTypeFilter": true
        },
        "osPlatform": "Linux",
        "visible": true
      },
      {
        "name": "adminUser",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin User",
        "defaultValue": "hpcadmin",
        "toolTip": "Local admin user for the Virtual Machines",
        "constraints": {
          "required": true,
          "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$",
          "validationMessage": "Enter a valid username"
        },
        "visible": true
      },
      {
        "name": "adminPasswordBox",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "Admin Password",
          "confirmPassword": "Confirm password"
        },
        "toolTip": "The Admin User password",
        "constraints": {
          "required": true,
          "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
          "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      },
      {
        "name": "autogeneratePasswordsAndKeys",
        "type": "Microsoft.Common.DropDown",
        "label": "SSH public key source",
        "defaultValue": "Use existing public key",
        "toolTip": "Public keys can be entered manually or retrieved from an Azure Public Key resource",
        "constraints": {
          "allowedValues": [
            {
              "label": "Use existing public key",
              "value": "entered"
            },
            {
              "label": "Use key stored in Azure",
              "value": "stored"
            }
          ],
          "required": true
        }
      },
      {
        "name": "adminSshPublicKey",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin SSH Public Key",
        "toolTip": "SSH Public Key for the Virtual Machines",
        "constraints": {
          "required": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]",
          "regex": "^ssh-[a-zA-Z0-9]+ [A-Za-z0-9+/=]+(?: .*)?$",
          "validationMessage": "Invalid SSH public key"
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]"
      },
      {
        "name": "keySelector",
        "type": "Microsoft.Solutions.ResourceSelector",
        "label": "Select stored SSH key",
        "toolTip": "Select a stored SSH public key",
        "resourceType": "Microsoft.Compute/sshPublicKeys",
        "options": {
          "filter": {
            "subscription": "onBasics"
          }
        },
        "constraints": {
          "required": true,
          "validationMessage": "Please select a stored SSH key."
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'stored')]"
      },
      {
        "name": "enableEntra",
        "type": "Microsoft.Common.CheckBox",
        "label": "Enable Microsoft Entra ID SSO",
        "toolTip": "Enable single sign-on (SSO) with Microsoft Entra ID",
        "defaultValue": false,
        "constraints": {
          "required": false
        }
      },
      {
        "name": "entraManagedIdentity",
        "type": "Microsoft.Solutions.ResourceSelector",
        "label": "Managed Identity",
        "toolTip": "Select the user-assigned managed identity created for the federated credentials associated with the application registration",
        "resourceType": "Microsoft.ManagedIdentity/userAssignedIdentities",
        "constraints": {
          "required": true,
          "validationMessage": "Please select a managed identity."
        },
        "visible": "[basics('enableEntra')]"
      },
      {
        "name": "tenantId",
        "type": "Microsoft.Common.TextBox",
        "label": "Tenant ID",
        "defaultValue": "",
        "toolTip": "Tenant ID of the Entra ID application registration",
        "constraints": {
          "required": true,
          "regex": "^[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}$",
          "validationMessage": "Enter a valid tenant ID"
        },
        "visible": "[basics('enableEntra')]"
      },
      {
        "name": "clientId",
        "type": "Microsoft.Common.TextBox",
        "label": "Application (client) ID",
        "defaultValue": "",
        "toolTip": "Application or client ID of the Entra ID application registration",
        "constraints": {
          "required": true,
          "regex": "^[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}$",
          "validationMessage": "Enter a valid client ID"
        },
        "visible": "[basics('enableEntra')]"
      },
      {
        "name": "nullValue",
        "type": "Microsoft.Common.CheckBox",
        "label": "Null Value",
        "toolTip": "Null Value",
        "defaultValue": false,
        "visible": false
      }
    ],
    "steps": [
      {
        "name": "filesystem",
        "label": "File-system",
        "subLabel": {
          "preValidation": "Configure your home directory settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Filesystem Settings",
        "elements": [
          {
            "name": "shared",
            "type": "Microsoft.Common.Section",
            "label": "Primary file-system mount (for /shared and /home)",
            "elements": [
              {
                "name": "sharedInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "The directory /shared is a network attached mount and exists in all nodes of the cluster. Users' home directories reside within this mountpoint with the base homedir /shared/home."
                }
              },
              {
                "name": "newexisting",
                "type": "Microsoft.Common.DropDown",
                "label": "Create new file-system",
                "defaultValue": "Create new",
                "toolTip": "Create new file-system type or use existing for /shared directory",
                "multiselect": false,
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Create new",
                      "value": "new"
                    },
                    {
                      "label": "Use existing external NFS",
                      "value": "existing"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "filertype",
                "type": "Microsoft.Common.DropDown",
                "label": "File-system Type",
                "defaultValue": "[if(equals(steps('filesystem').shared.newexisting,'new'),'Builtin NFS','External NFS')]",
                "toolTip": "Filer type for the /shared directory",
                "multiselect": false,
                "constraints": {
                  "allowedValues": "[parse(concat('[{\"label\":\"', 'Builtin NFS','\",\"value\":\"nfs\"}',if(contains(steps('basics').anfAvailabilityZonesApi, 'properties'),',',''),if(contains(steps('basics').anfAvailabilityZonesApi, 'properties'),'{\"label\":\"Azure NetApp Files\",\"value\":\"anf\"}',''),']'))]",
                  "required": true
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'new')]"
              },
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('filesystem').shared.filertype,'anf')]",
                "options": {
                  "icon": "Warning",
                  "text": "NetApp Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "anfInfoBoxSlurmHA",
                "type": "Microsoft.Common.InfoBox",
                "visible": false,
                "options": {
                  "icon": "Warning",
                  "text": "Slurm High Availability will be unavailable in Slurm Settings with this choice of file-system."
                }
              },
              {
                "name": "anftier",
                "type": "Microsoft.Common.DropDown",
                "label": "Service Level",
                "defaultValue": "Premium",
                "multiselect": false,
                "toolTip": "Service level for the Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard",
                      "value": "Standard"
                    },
                    {
                      "label": "Premium",
                      "value": "Premium"
                    },
                    {
                      "label": "Ultra",
                      "value": "Ultra"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
              },
              {
                "name": "anfcapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the Azure NetApp Files volume",
                "subLabel": "TiB",
                "defaultValue": "4",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": "[and(equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
              },
              {
                "name": "nfscapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the NFS volume",
                "subLabel": "GB",
                "defaultValue": "1024",
                "constraints": {
                  "required": true,
                  "regex": "^(100|10[0-1]\\d{3}|[1-9]\\d{2}|[1-9]\\d{3}|[1-9]\\d{4}|102400)$",
                  "validationMessage": "Please enter an integer between 100 and 102400"
                },
                "visible": "[and(equals(steps('filesystem').shared.newexisting,'new'),equals(steps('filesystem').shared.filertype,'nfs'))]"
              },
              {
                "name": "ipAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "IP Address",
                "toolTip": "IP address of the filer mount",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              },
              {
                "name": "exportPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Export path",
                "defaultValue": "/shared",
                "toolTip": "Export path for the primary filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              },
              {
                "name": "mountOptions",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount options",
                "defaultValue": "rw,hard,rsize=262144,wsize=262144,vers=3,tcp,_netdev",
                "toolTip": "Mount options for the primary filer",
                "constraints": {
                  "required": false,
                  "regex": "^.+$",
                  "validationMessage": "Please enter a mount option"
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              }
            ],
            "visible": true
          },
          {
            "name": "additionalCheck",
            "type": "Microsoft.Common.Section",
            "label": "Additional file-system mount",
            "elements": [
              {
                "name": "additionalInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Optionally mount another endpoint on the cluster nodes."
                }
              },
              {
                "name": "checkbox",
                "type": "Microsoft.Common.CheckBox",
                "label": "Add another file-system mount",
                "toolTip": "Add an additional filer",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "additional",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "newexisting",
                "type": "Microsoft.Common.DropDown",
                "label": "Create new file-system",
                "defaultValue": "Create new",
                "toolTip": "Create new file-system or use existing",
                "multiselect": false,
                "constraints": {
                  "allowedValues": "[parse(concat('[',if(or(contains(steps('basics').anfAvailabilityZonesApi, 'properties'),not(equals(length(filter(steps('basics').amlAvailabilityZonesApi.value, (item) => equals(toLower(first(item.locations)), location()))),0))),'{\"label\":\"Create new\",\"value\":\"new\"},',''),'{\"label\":\"Use existing\",\"value\":\"existing\"}]'))]",
                  "required": true
                },
                "visible": true
              },
              {
                "name": "filertype",
                "type": "Microsoft.Common.DropDown",
                "label": "File-system Type",
                "defaultValue": "[if(equals(steps('filesystem').additional.newexisting,'new'),if(contains(steps('basics').anfAvailabilityZonesApi, 'properties'),'Azure NetApp Files', 'Azure Managed Lustre'),'External NFS')]",
                "toolTip": "File-system type",
                "multiselect": false,
                "constraints": {
                  "allowedValues": "[parse(concat('[',if(or(contains(steps('basics').anfAvailabilityZonesApi, 'properties'), equals(steps('filesystem').additional.newexisting,'existing')),concat('{\"label\":\"',if(equals(steps('filesystem').additional.newexisting,'new'),'Azure NetApp Files','External NFS'),'\",\"value\":\"',if(equals(steps('filesystem').additional.newexisting,'new'),'anf','nfs'),'\"}'),''),if(or(equals(steps('filesystem').additional.newexisting,'existing'),and(contains(steps('basics').anfAvailabilityZonesApi, 'properties'),not(equals(length(filter(steps('basics').amlAvailabilityZonesApi.value, (item) => equals(toLower(first(item.locations)), location()))),0)))),',',''),if(and(not(equals(steps('filesystem').additional.newexisting,'existing')),equals(length(filter(steps('basics').amlAvailabilityZonesApi.value, (item) => equals(toLower(first(item.locations)), location()))),0)),'',concat('{\"label\":\"',if(equals(steps('filesystem').additional.newexisting,'new'),'Azure Managed Lustre','External Azure Managed Lustre'),'\",\"value\":\"aml\"}')),']'))]",
                  "required": true
                },
                "visible": true
              },
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('filesystem').additional.filertype,'anf')]",
                "options": {
                  "icon": "Warning",
                  "text": "NetApp Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "anfInfoBoxSlurmHA",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(false, equals(steps('filesystem').additional.filertype,'anf'))]",
                "options": {
                  "icon": "Warning",
                  "text": "Slurm High Availability will be unavailable in Slurm Settings with this choice of file-system."
                }
              },
              {
                "name": "amlInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('filesystem').additional.filertype,'aml')]",
                "options": {
                  "icon": "Warning",
                  "text": "HPC Cache Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "amlInfoBoxLargeCluster",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),greater(steps('filesystem').additional.azurelustrecapacity,128))]",
                "options": {
                  "icon": "Warning",
                  "text": "The Large Cluster feature must be enabled for the subscription chosen in the Basics menu to deploy an Azure Managed Lustre cluster with volume capacity exceeding 128 TiB.\n\nClick on this infobox to open a support ticket to enable this feature in a new tab.",
                  "uri": "https://ms.portal.azure.com/#view/Microsoft_Azure_Support/HelpAndSupportBlade/%7E/overview"
                }
              },
              {
                "name": "anftier",
                "type": "Microsoft.Common.DropDown",
                "label": "Service Level",
                "defaultValue": "Premium",
                "multiselect": false,
                "toolTip": "Service level for the Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard",
                      "value": "Standard"
                    },
                    {
                      "label": "Premium",
                      "value": "Premium"
                    },
                    {
                      "label": "Ultra",
                      "value": "Ultra"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "anfcapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the Azure NetApp Files volume",
                "subLabel": "TiB",
                "defaultValue": "4",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "lustretier",
                "type": "Microsoft.Common.DropDown",
                "label": "Lustre Tier",
                "defaultValue": "AMLFS-Durable-Premium-500",
                "multiselect": false,
                "toolTip": "Select the Azure Manage Lustre SKU to use",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "AMLFS-Durable-Premium-40",
                      "description": "40 MB/s/TB, 48TB size increment",
                      "value": "AMLFS-Durable-Premium-40"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-125",
                      "description": "125 MB/s/TB, 16TB size increment",
                      "value": "AMLFS-Durable-Premium-125"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-250",
                      "description": "250 MB/s/TB, 8TB size increment",
                      "value": "AMLFS-Durable-Premium-250"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-500",
                      "description": "500 MB/s/TB, 4TB size increment",
                      "value": "AMLFS-Durable-Premium-500"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "azurelustrecapacity",
                "type": "Microsoft.Common.Slider",
                "min": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),48,if(endsWith(steps('filesystem').additional.lustretier,'-125'),16,if(endsWith(steps('filesystem').additional.lustretier,'-250'),8,4))))]",
                "max": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),12768,if(endsWith(steps('filesystem').additional.lustretier,'-125'),4096,if(endsWith(steps('filesystem').additional.lustretier,'-250'),2048,1024))))]",
                "step": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),48,if(endsWith(steps('filesystem').additional.lustretier,'-125'),16,if(endsWith(steps('filesystem').additional.lustretier,'-250'),8,4))))]",
                "label": "Capacity",
                "subLabel": "TiB",
                "defaultValue": 4,
                "showStepMarkers": true,
                "toolTip": "Capacity of the Azure Managed Lustre volume",
                "constraints": {
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "ipAddressNfs",
                "type": "Microsoft.Common.TextBox",
                "label": "IP Address",
                "toolTip": "IP address of the filer mount",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting,'existing'),equals(steps('filesystem').additional.filertype,'nfs'))]"
              },
              {
                "name": "ipAddressAml",
                "type": "Microsoft.Common.TextBox",
                "label": "MGS IP Address",
                "toolTip": "The IP address for the Azure Managed Lustre file system's Lustre Management Service",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting,'existing'),equals(steps('filesystem').additional.filertype,'aml'))]"
              },
              {
                "name": "mountPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount path",
                "defaultValue": "/data",
                "toolTip": "Mount path for the additional filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": true
              },
              {
                "name": "exportPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Export path",
                "defaultValue": "/mnt/data",
                "toolTip": "Export path for the additional filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting, 'existing'),not(equals(steps('filesystem').additional.filertype,'aml')))]"
              },
              {
                "name": "mountOptionsNfs",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount options",
                "defaultValue": "rw,hard,rsize=262144,wsize=262144,vers=3,tcp,_netdev",
                "toolTip": "Mount options for the additional filer",
                "constraints": {
                  "required": false,
                  "regex": "^.+$",
                  "validationMessage": "Please enter a mount option."
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting,'existing'),equals(steps('filesystem').additional.filertype,'nfs'))]"
              },
              {
                "name": "mountOptionsAml",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount options",
                "defaultValue": "noatime,user_xattr",
                "toolTip": "Mount options for the additional filer",
                "constraints": {
                  "required": false,
                  "regex": "^.+$",
                  "validationMessage": "Please enter a mount option."
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting,'existing'),equals(steps('filesystem').additional.filertype,'aml'))]"
              }
            ],
            "visible": "[steps('filesystem').additionalCheck.checkbox]"
          }
        ]
      },
      {
        "name": "networking",
        "label": "Networking",
        "elements": [
          {
            "name": "networking",
            "type": "Microsoft.Common.Section",
            "label": "Networking",
            "elements": [
              {
                "name": "header",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Optionally automatically create virtual network resources or use existing ones for the cluster deployment."
                }
              },
              {
                "name": "infobox",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Private DNS zone, private DNS zone group, and virtual network link resources are needed to establish network connectivity with the storage account deployed for use by the cluster via private endpoint."
                }
              }
            ],
            "visible": true
          },
          {
            "name": "newexisting",
            "type": "Microsoft.Common.DropDown",
            "label": "Virtual network options",
            "defaultValue": "Automatically create new virtual network and subnets",
            "toolTip": "Auto-create new networking resources or use an existing virtual network and subnets",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Automatically create new virtual network and subnets",
                  "value": "new"
                },
                {
                  "label": "Use existing virtual network and subnets",
                  "value": "existing"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "networkSettings",
            "type": "Microsoft.Common.Section",
            "label": "Network configuration",
            "elements": [
              {
                "name": "lustreInfoBoxNew",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),equals(steps('networking').newexisting,'new'))]",
                "options": {
                  "icon": "Warning",
                  "text": "[concat('The minimum CIDR required to deploy a new instance of Azure Managed Lustre at the volume capacity specified in the File-system menu is ',if(lessOrEquals(steps('filesystem').additional.azurelustrecapacity,256),'/23',if(and(greater(steps('filesystem').additional.azurelustrecapacity,256),lessOrEquals(steps('filesystem').additional.azurelustrecapacity,512)),'/22','/21')),'. Incompatible options are therefore omitted in the below dropdown.')]"
                }
              },
              {
                "name": "cidrPrefix",
                "type": "Microsoft.Common.DropDown",
                "label": "CIDR Prefix",
                "defaultValue": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),if(lessOrEquals(steps('filesystem').additional.azurelustrecapacity,256),'/23',if(and(greater(steps('filesystem').additional.azurelustrecapacity,256),lessOrEquals(steps('filesystem').additional.azurelustrecapacity,512)),'/22','/21')),'/24')]",
                "multiLine": true,
                "toolTip": "Select the CIDR prefix",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','/24')]",
                      "description": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','123 compute nodes')]",
                      "value": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','/24')]"
                    },
                    {
                      "label": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,256)),'','/23')]",
                      "description": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,256)),'','251 compute nodes')]",
                      "value": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,256)),'','/23')]"
                    },
                    {
                      "label": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,512)),'','/22')]",
                      "description":  "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,512)),'','506 compute nodes')]",
                      "value": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),greater(steps('filesystem').additional.azurelustrecapacity,512)),'','/22')]"
                    },
                    {
                      "label": "/21",
                      "description": "1019 compute nodes",
                      "value": "/21"
                    },
                    {
                      "label": "/20",
                      "description": "2043 compute nodes",
                      "value": "/20"
                    }
                  ],
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "baseIpAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "Base IP Address",
                "defaultValue": "10.0.0.0",
                "toolTip": "The base IP address for the IP range",
                "multiLine": false,
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "networkSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Virtual network",
                "toolTip": "Select existing virtual network",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "subNetProvidersApi",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(substring(steps('networking').networkSettings.networkSelector.id,0,length(steps('networking').networkSettings.networkSelector.id)),'/subnets?api-version=2024-05-01')]"
                }
              },
              {
                "name": "ccsubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "CycleCloud subnet",
                "toolTip": "Select subnet for CycleCloud",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "computesubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Compute node subnet",
                "toolTip": "Select subnet for compute nodes",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "anfInfoBox1",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').shared.filertype, 'anf'), equals(steps('networking').newexisting,'existing'), equals(0,length(first(map(filter(steps('networking').networkSettings.subNetProvidersApi.value, (item) => equals(item.name, steps('networking').networkSettings.filersubnet1)), (item) => filter(item.properties.delegations, (item) => equals(item.properties.serviceName, 'Microsoft.Netapp/volumes')))))))]",
                "options": {
                  "icon": "Warning",
                  "text": "The subnet selected below is missing the Microsoft.NetApp/volumes delegation required to use Azure NetApp Files.\nIt must have this delegation for the deployment to succeed.\n\nClick on this box to view the relevant official documentation in a new browser tab.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/how-to/ccws/plan-your-deployment?view=cyclecloud-8#brownfield-deployment"
                }
              },
              {
                "name": "filersubnet1",
                "type": "Microsoft.Common.DropDown",
                "label": "Primary file-system subnet",
                "toolTip": "Select subnet for primary file-system",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').shared.filertype, 'anf'), equals(steps('networking').newexisting,'existing'))]"
              },
              {
                "name": "anfInfoBox2",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('networking').newexisting,'existing'),steps('filesystem').additionalCheck.checkbox,equals(steps('filesystem').additional.filertype,'anf'), equals(0,length(first(map(filter(steps('networking').networkSettings.subNetProvidersApi.value, (item) => equals(item.name, steps('networking').networkSettings.filersubnet2)), (item) => filter(item.properties.delegations, (item) => equals(item.properties.serviceName, 'Microsoft.Netapp/volumes')))))))]",
                "options": {
                  "icon": "Warning",
                  "text": "The subnet selected below is missing the Microsoft.NetApp/volumes delegation required to use Azure NetApp Files.\nIt must have this delegation for the deployment to succeed.\n\nClick on this box to view the relevant official documentation in a new browser tab.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/how-to/ccws/plan-your-deployment?view=cyclecloud-8#brownfield-deployment"
                }
              },
              {
                "name": "lustreInfoBoxExisting",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),equals(steps('networking').newexisting,'existing'))]",
                "options": {
                  "icon": "Warning",
                  "text": "The minimum CIDR required to deploy a new instance of Azure Managed Lustre is /23.\n\nPlease ensure that the subnet selected below meets this requirement."
                }
              },
              {
                "name": "filersubnet2",
                "type": "Microsoft.Common.DropDown",
                "label": "Additional file-system subnet",
                "toolTip": "Select subnet for additional file-system",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' (',if(contains(item.properties,'addressPrefix'),item.properties.addressPrefix,first(item.properties.addressPrefixes)), ')', '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'existing'),steps('filesystem').additionalCheck.checkbox,equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "bastion",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a Bastion for SSH connections",
                "toolTip": "Deploy an Azure Bastion for SSH connections",
                "defaultValue": false,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "natgateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a NAT Gateway",
                "toolTip": "Create a NAT Gateway for outbound traffic",
                "defaultValue": true,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "peering",
                "type": "Microsoft.Common.CheckBox",
                "label": "Peer to an existing virtual network",
                "defaultValue": false,
                "toolTip": "Enable peering to your existing virtual network",
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "vnetPeeredVnetSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select virtual network for peering",
                "toolTip": "Network must be in the same subscription",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              },
              {
                "name": "gateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow gateway transit",
                "defaultValue": false,
                "toolTip": "Enable if peering VNet has a gateway",
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              }
            ],
            "visible": true
          },
          {
            "name": "dnsZone",
            "type": "Microsoft.Common.Section",
            "label": "Private DNS zone",
            "elements": [
              {
                "name": "dnsZoneInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Optionally automatically create private DNS zone and virtual network link resources or use existing ones to connect the virtual network chosen above with the cluster storage account via a private endpoint."
                }
              },
              {
                "name": "newDnsZoneWarning",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('networking').dnsZone.newExisting,'new')]",
                "options": {
                  "icon": "Warning",
                  "text": "The cluster deployment will fail if the virtual network selected above has an existing link to a private DNS zone for\nAzure Blob Storage and the option to create a new such private DNS zone resource is chosen below."
                }
              },
              {
                "name": "newExisting",
                "type": "Microsoft.Common.DropDown",
                "label": "Private DNS zone options",
                "defaultValue": "Use an existing private DNS zone",
                "toolTip": "Create a new or use an existing private DNS zone for Azure Blob Storage",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Use an existing private DNS zone",
                      "value": "existing"
                    },
                    {
                      "label": "Automatically create a new private DNS zone",
                      "value": "new"
                    },
                    {
                      "label": "Do not use a private DNS zone",
                      "value": "none"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "dnsZoneSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Private DNS zone",
                "toolTip": "Select existing private DNS zone for Azure Blob Storage",
                "resourceType": "Microsoft.Network/privateDnsZones",
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('networking').dnsZone.newExisting,'existing')]"
              },
              {
                "name": "badDnsZoneWarning",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('networking').dnsZone.newExisting,'existing')]",
                "options": {
                  "icon": "Warning",
                  "text": "Select an appropriate private DNS zone to ensure that the cluster deployment will not fail and that the chosen virtual network can connect to Azure Blob Storage via a private endpoint.\n\nThe name of the chosen private DNS zone must be one of the following:\n • privatelink.blob.core.windows.net\n • privatelink.blob.core.usgovcloudapi.net"
                }
              },
              {
                "name": "vnetLinkProvidersApi",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(steps('networking').dnsZone.dnsZoneSelector.id,'/virtualNetworkLinks?api-version=2018-09-01')]"
                }
              }
            ],
            "visible": "[equals(steps('networking').newexisting,'existing')]"
          },
          {
            "name": "vnetLink",
            "type": "Microsoft.Common.Section",
            "label": "Virtual network link",
            "elements": [
              {
                "name": "vnetLinkWarning",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Warning",
                  "text": "The selected private DNS zone is not linked to the selected virtual network.\n\nCheck the box below to create such a virtual network link resource for the cluster and ensure connectivity with the storage account that will be concurrently deployed for use by the cluster via private endpoint."
                }
              },
              {
                "name": "createVnetLink",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create virtual network link",
                "toolTip": "Automatically link the selected virtual network with the selected private DNS zone",
                "defaultValue": false,
                "visible": true
              }
            ],
            "visible": "[if(and(equals(steps('networking').dnsZone.newExisting,'existing'),not(equals(0,length(steps('networking').networkSettings.networkSelector.id))),not(equals(0,length(steps('networking').dnsZone.dnsZoneSelector.id))),or(equals(steps('networking').dnsZone.dnsZoneSelector.name,'privatelink.blob.core.windows.net'),equals(steps('networking').dnsZone.dnsZoneSelector.name,'privatelink.blob.core.usgovcloudapi.net'))),not(equals(length(filter(steps('networking').dnsZone.vnetLinkProvidersApi.value, (item) => equals(item.properties.virtualNetwork.id,steps('networking').networkSettings.networkSelector.id))),1)),false)]"
          }
        ]
      },
      {
        "name": "scheduler",
        "label": "Slurm Settings",
        "elements": [
          {
            "name": "clusterSettings",
            "type": "Microsoft.Common.Section",
            "label": "Cluster Configuration",
            "elements": [
              {
                "name": "startClusterInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[steps('scheduler').clusterSettings.startCluster]",
                "options": {
                  "text": "Postponing the start of the cluster allows for additional configuration through the CycleCloud portal or with a custom cluster template. Click on this box to view the official Azure CycleCloud documentation in a new browser tab.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/?view=cyclecloud-8"
                }
              },
              {
                "name": "startCluster",
                "type": "Microsoft.Common.CheckBox",
                "label": "Start cluster",
                "toolTip": "Automatically start the Slurm cluster following deployment completion",
                "defaultValue": true,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "acceptMarketplaceTerms",
                "type": "Microsoft.Common.CheckBox",
                "label": "Auto-accept VM image terms",
                "toolTip": "Enable CycleCloud to automatically accept any Azure Marketplace VM image terms for the selected Azure subscription",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "healthCheck",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable health check",
                "toolTip": "Enable health check scripts (NHC) to be run during allocation",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "clusterName",
                "type": "Microsoft.Common.TextBox",
                "label": "Cluster name",
                "defaultValue": "ccw",
                "toolTip": "Name of cluster in CycleCloud portal",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9@_-]{3,}$",
                  "validationMessage": "Cluster name must be at least 3 characters long. Characters must be alphanumeric, @, -, or _."
                },
                "visible": false
              }
            ],
            "visible": true
          },
          {
            "name": "schedulerSection",
            "type": "Microsoft.Common.Section",
            "label": "Scheduler",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a size for the Scheduler VM",
                "recommendedSizes": [
                  "Standard_D4as_v5",
                  "Standard_D4s_v5",
                  "Standard_D4as_v4",
                  "Standard_D4s_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "constraints": {
                  "excludedSizes": [
                    "Standard_D4as_v6",
                    "Standard_D2als_v6",
                    "Standard_D4als_v6",
                    "Standard_D8als_v6",
                    "Standard_D16als_v6",
                    "Standard_D32als_v6",
                    "Standard_D48als_v6",
                    "Standard_D64als_v6",
                    "Standard_D96als_v6",
                    "Standard_D2s_v6",
                    "Standard_D4s_v6",
                    "Standard_D8s_v6",
                    "Standard_D16s_v6",
                    "Standard_D32s_v6",
                    "Standard_D48s_v6",
                    "Standard_D64s_v6",
                    "Standard_D96s_v6",
                    "Standard_D128s_v6"
                  ]
                },
                "osPlatform": "Linux",
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the Login Nodes",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux8"
                    },
                    {
                      "label": "Alma Linux 9",
                      "value": "almalinux9"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                }
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('scheduler').schedulerSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('scheduler').schedulerSection.ImageName,'custom')]"
              },
              {
                "name": "universalImage",
                "type": "Microsoft.Common.CheckBox",
                "label": "Use image on all nodes",
                "toolTip": "Use the indicated image on all nodes",
                "defaultValue": false,
                "visible": true
              },
              {
                "name": "slurmVersion",
                "type": "Microsoft.Common.DropDown",
                "label": "Slurm Version",
                "defaultValue": "25.05.2",
                "toolTip": "Select the version of Slurm to use",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "25.05.2",
                      "description": "Version 25.05.2",
                      "value": "25.05.2"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "slurmHA",
                "type": "Microsoft.Common.CheckBox",
                "label": "Slurm HA",
                "toolTip": "Select to enable Slurm High Availability",
                "defaultValue": false,
                "visible": false
              },
              {
                "name": "slurmAccounting",
                "type": "Microsoft.Common.CheckBox",
                "label": "Slurm job accounting",
                "toolTip": "Select to enable Slurm job accounting in a managed MySQL instance",
                "defaultValue": false,
                "visible": true
              },
              {
                "name": "databaseInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]",
                "options": {
                  "icon": "Warning",
                  "text": "CycleCloud Workspace for Slurm currently only supports job accounting in existing MySQL instances. \nPlease visit the linked page to create a new MySQL instance prior to launching CycleCloud Workspace for Slurm.",
                  "uri": "https://portal.azure.com/#create/Microsoft.MySQLServer"
                }
              },
              {
                "name": "databaseUser",
                "type": "Microsoft.Common.TextBox",
                "label": "Database user",
                "defaultValue": "hpcdbadmin",
                "toolTip": "Username of the Slurm accounting database admin",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$",
                  "validationMessage": "Enter a valid username"
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "databaseAdminPassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Database Admin Password",
                  "confirmPassword": "Confirm Password"
                },
                "toolTip": "Password for the Slurm accounting database admin user",
                "constraints": {
                  "required": "[not(equals(basics('autogeneratePasswordsAndKeys'),1))]",
                  "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
                  "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
                },
                "options": {
                  "hideConfirmation": false
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "dbConnection",
                "type": "Microsoft.Common.DropDown",
                "label": "Connection options",
                "defaultValue": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: FQDN',if(equals(steps('networking').newexisting,'new'),'Private Endpoint',''))]",
                "toolTip": "Select method by which to connect to the existing MySQL database",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: FQDN','')]",
                      "value": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'fqdn','')]"
                    },
                    {
                      "label": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: Private IP','')]",
                      "value": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'privateIp','')]"
                    },
                    {
                      "label": "[if(equals(steps('networking').newexisting,'new'),'Private Endpoint','')]",
                      "value": "[if(equals(steps('networking').newexisting,'new'),'privateEndpoint','')]"
                    }
                  ],
                  "required": true
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "databaseURL",
                "type": "Microsoft.Common.TextBox",
                "label": "Database FQDN (URL)",
                "defaultValue": ".mysql.database.azure.com",
                "toolTip": "Enter a FQDN (URL) for the MySQL database",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:http[s]?:\\/\\/.)?(?:www\\.)?[-a-zA-Z0-9@%._\\+~#=]{2,256}\\.[a-z]{2,6}\\b(?:[-a-zA-Z0-9@:%_\\+.~#?&\/\/=]*)$",
                      "message": "Please enter a valid MySQL database FQDN."
                    }
                  ]
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'fqdn')]"
              },
              {
                "name": "databasePIP",
                "type": "Microsoft.Common.TextBox",
                "label": "Database Private IP",
                "defaultValue": "",
                "toolTip": "Enter the private IP address of the MySQL database",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'privateIp')]"
              },
              {
                "name": "dbSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select MySQL Database",
                "toolTip": "Select a MySQL Flexible Server in the Azure region selected in the Basics menu",
                "resourceType": "Microsoft.DBforMySQL/flexibleServers",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "constraints": {
                  "required": true,
                  "validationMessage": "Please select a MySQL Flexible Server."
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'privateEndpoint')]"
              },
              {
                "name": "useLoginNodes",
                "type": "Microsoft.Common.CheckBox",
                "label": "Use login nodes",
                "toolTip": "Select to create login nodes for your cluster",
                "defaultValue": false,
                "visible": false
              }
            ]
          },
          {
            "name": "loginNodesSection",
            "type": "Microsoft.Common.Section",
            "label": "Login Nodes",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the Login nodes",
                "recommendedSizes": [
                  "Standard_F4s_v2"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the Login Nodes",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux8"
                    },
                    {
                      "label": "Alma Linux 9",
                      "value": "almalinux9"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('scheduler').loginNodesSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('scheduler').loginNodesSection.ImageName,'custom')]"
              },
              {
                "name": "initialNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Initial number of nodes",
                "defaultValue": "1",
                "toolTip": "Enter a number between 0 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[0-9]|[1-9][0-9]|[1-9][0-9][0-9]|1000)$",
                  "validationMessage": "Please enter an integer between 0 and 1000"
                },
                "visible": true
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Maximum number of nodes",
                "defaultValue": "1",
                "toolTip": "Enter a number between 1 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "slurmSettings",
        "label": "Partition Settings",
        "elements": [
          {
            "name": "partitionSettings",
            "type": "Microsoft.Common.Section",
            "label": "Partition Settings",
            "elements": [
              {
                "name": "header",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Slurm uses partitions to distinguish different execute node types. This workspace provides for three common use cases: High-Throughput Compute (HTC), CPU-based High-Performance Compute (HPC), and GPU-based HPC (GPU)."
                }
              }
            ],
            "visible": true
          },
          {
            "name": "HTCSection",
            "type": "Microsoft.Common.Section",
            "label": "HTC Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the HTC partition",
                "recommendedSizes": [
                  "Standard_F2s_v2"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Maximum number of nodes",
                "defaultValue": "100",
                "toolTip": "Enter 0 to not use this partition",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[0-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 0 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the HTC partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux8"
                    },
                    {
                      "label": "Alma Linux 9",
                      "value": "almalinux9"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').HTCSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').HTCSection.ImageName,'custom')]"
              },
              {
                "name": "spotHTC",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Azure Spot",
                "toolTip": "Enable Azure Spot discount",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "HPCSection",
            "type": "Microsoft.Common.Section",
            "label": "HPC Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the HPC partition",
                "recommendedSizes": [
                  "Standard_HB120rs_v3",
                  "Standard_HB176rs_v4",
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Maximum number of nodes",
                "defaultValue": "16",
                "toolTip": "Enter 0 to not use this partition",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[0-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 0 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the HPC partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux8"
                    },
                    {
                      "label": "Alma Linux 9",
                      "value": "almalinux9"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').HPCSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').HPCSection.ImageName,'custom')]"
              },
              {
                "name": "spotHPC",
                "label": "Enable Azure Spot",
                "type": "Microsoft.Common.CheckBox",
                "toolTip": "Enable Azure Spot discount",
                "defaultValue": false,
                "visible": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "GPUSection",
            "type": "Microsoft.Common.Section",
            "label": "GPU Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the GPU partition",
                "recommendedSizes": [
                  "Standard_ND96asr_v4",
                  "Standard_ND96amsr_A100_v4",
                  "Standard_NC24ads_A100_v4",
                  "Standard_ND96isr_H100_v5",
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Maximum number of nodes",
                "defaultValue": "8",
                "toolTip": "Enter 0 to not use this partition",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[0-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 0 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the GPU partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux8"
                    },
                    {
                      "label": "Alma Linux 9",
                      "value": "almalinux9"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').GPUSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image URN or ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image URN or ID",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').GPUSection.ImageName,'custom')]"
              },
              {
                "name": "spotGPU",
                "type": "Microsoft.Common.CheckBox",
                "toolTip": "Enable Azure Spot discount",
                "label": "Enable Azure Spot",
                "defaultValue": false,
                "visible": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          }
        ]
      },
      {
        "name": "ood",
        "label": "Open OnDemand",
        "elements": [
          {
            "name": "OODSection",
            "type": "Microsoft.Common.Section",
            "label": "Open OnDemand",
            "elements": [
              {
                "name": "oodInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Open OnDemand is an open-source, web-based portal developed by the Ohio Supercomputer Center (OSC) to provide easy access to high-performance computing (HPC) resources. The platform allows users to submit and monitor jobs, manage files, and run applications from anywhere using only a web browser. The portal is designed to simplify the user experience, making it accessible for both novice and experienced HPC users."
                }
              },
              {
                "name": "oodEntraInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[not(basics('enableEntra'))]",
                "options": {
                  "icon": "Error",
                  "text": "Open OnDemand requires the use of Microsoft Entra ID for single sign-on (SSO) to Azure CycleCloud. Configuration for this setting can be found on the Basics menu with links to official documentation."
                }
              },
              {
                "name": "deployOOD",
                "type": "Microsoft.Common.CheckBox",
                "label": "Deploy Open OnDemand",
                "toolTip": "Deploy Open OnDemand alongside the Slurm cluster",
                "defaultValue": true,
                "constraints": {
                  "required": false
                },
                "visible": "[basics('enableEntra')]"
              },
              {
                "name": "oodLoginNodeInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('ood').OODSection.deployOOD,equals(int(steps('scheduler').loginNodesSection.initialNodes),0),basics('enableEntra'))]",
                "options": {
                  "icon": "Warning",
                  "text": "Open OnDemand requires a minimum of one login node for use as a proxy between Azure CycleCloud and the Open OnDemand web server. Please review selections made under the Slurm Settings menu."
                }
              },
              {
                "name": "oodFilesystemInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('ood').OODSection.deployOOD,not(equals(steps('filesystem').shared.filertype,'anf')),basics('enableEntra'))]",
                "options": {
                  "icon": "Info",
                  "text": "Open OnDemand is best-deployed with Azure NetApp Files as the file-system for the /shared and /home directories."
                }
              },
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Open OnDemand VM Size",
                "toolTip": "Select a SKU for the Open OnDemand VM",
                "recommendedSizes": [
                  "Standard_D4as_v5",
                  "Standard_D4s_v5",
                  "Standard_D4as_v4",
                  "Standard_D4s_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "constraints": {
                  "excludedSizes": [
                    "Standard_D4as_v6",
                    "Standard_D2als_v6",
                    "Standard_D4als_v6",
                    "Standard_D8als_v6",
                    "Standard_D16als_v6",
                    "Standard_D32als_v6",
                    "Standard_D48als_v6",
                    "Standard_D64als_v6",
                    "Standard_D96als_v6",
                    "Standard_D2s_v6",
                    "Standard_D4s_v6",
                    "Standard_D8s_v6",
                    "Standard_D16s_v6",
                    "Standard_D32s_v6",
                    "Standard_D48s_v6",
                    "Standard_D64s_v6",
                    "Standard_D96s_v6",
                    "Standard_D128s_v6"
                  ]
                },
                "osPlatform": "Linux",
                "visible": "[and(steps('ood').OODSection.deployOOD,basics('enableEntra'))]"
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the OOD virtual machine",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Ubuntu 24.04",
                      "value": "cycle.image.ubuntu24"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "cycle.image.ubuntu22"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[and(steps('ood').OODSection.deployOOD,basics('enableEntra'))]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('ood').OODSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('ood').OODSection.ImageName,'custom')]"
              },
              {
                "name": "userDomain",
                "type": "Microsoft.Common.TextBox",
                "label": "User domain",
                "defaultValue": "contoso.com",
                "toolTip": "Domain of user email addresses or the LUA expression [%w%.%-]+ for all domains of the email addresses provided by the OIDC token",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.[a-zA-Z]{2,}$|^\\[%w%\\.%-\\]\\+$",
                  "validationMessage": "Enter either a single valid domain name or the LUA expression [%w%.%-]+ to use all domains of the email addresses provided by the OIDC token"
                },
                "visible": "[and(steps('ood').OODSection.deployOOD,basics('enableEntra'))]"
              },
              {
                "name": "fqdn",
                "type": "Microsoft.Common.TextBox",
                "label": "FQDN",
                "defaultValue": "",
                "toolTip": "FQDN for the Open OnDemand web server",
                "constraints": {
                  "required": false,
                  "regex": "^(?!-)[A-Za-z0-9-]+(?<!-)(\\.[A-Za-z0-9-]+(?<!-))*\\.[A-Za-z]{2,}$",
                  "validationMessage": "Enter a valid FQDN or leave blank"
                },
                "visible": "[and(steps('ood').OODSection.deployOOD,basics('enableEntra'))]"
              },
              {
                "name": "registerEntraIDApp",
                "type": "Microsoft.Common.DropDown",
                "label": "Microsoft Entra ID Application Registration",
                "defaultValue": "Use existing Entra ID Application registration",
                "toolTip": "Register a Microsoft Entra ID Application for Open OnDemand authentication using OpenID Connect",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Automatically register an Entra ID Application",
                      "value": "autoregister"
                    },
                    {
                      "label": "Use existing Entra ID Application registration",
                      "value": "existing"
                    },
                    {
                      "label": "Manual registration",
                      "value": "manual"
                    }
                  ],
                  "required": true
                },
                "visible": false
              },
              {
                "name": "ccEntraIdInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('ood').OODSection.deployOOD,basics('enableEntra'))]",
                "options": {
                  "text": "The Open OnDemand cluster will use the Entra ID Application Registration indicated in the Basics menu."
                }
              },
              {
                "name": "startClusterInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(not(equals(steps('ood').OODSection.registerEntraIDApp,'manual')),steps('ood').OODSection.startCluster,basics('enableEntra'))]",
                "options": {
                  "text": "Postponing the start of Open OnDemand allows for additional configuration through the CycleCloud portal or with a custom template. Click on this box to view the official Azure CycleCloud documentation in a new browser tab.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/?view=cyclecloud-8"
                }
              },
              {
                "name": "startClusterManualRegistration",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('ood').OODSection.deployOOD,equals(steps('ood').OODSection.registerEntraIDApp,'manual'))]",
                "options": {
                  "text": "Open OnDemand will not automatically start to allow for completion of the Microsoft Entra ID Application registration. Additional configuration through the CycleCloud portal or with a custom template is also possible. Click on this box to view the official Azure CycleCloud documentation in a new browser tab.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/?view=cyclecloud-8"
                }
              },
              {
                "name": "startCluster",
                "type": "Microsoft.Common.CheckBox",
                "label": "Start Open OnDemand",
                "toolTip": "Automatically start Open OnDemand following deployment completion",
                "defaultValue": true,
                "constraints": {
                  "required": false
                },
                "visible": "[and(steps('ood').OODSection.deployOOD,not(equals(steps('ood').OODSection.registerEntraIDApp,'manual')),basics('enableEntra'))]"
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "advancedSettings",
        "label": "Advanced",
        "elements": [
          {
            "name": "availabilityzone",
            "type": "Microsoft.Common.Section",
            "label": "Availability Zones",
            "elements": [
              {
                "name": "skuZoneInfo",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(subscription().id,'/providers/Microsoft.Compute/skus?api-version=2021-07-01&$filter=location%20eq%20%27', location(), '%27')]"
                }
              },
              {
                "name": "availabilityZoneHeader",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "Optionally enable availability zones for cluster compute nodes and any new file-system resources."
                },
                "visible": true
               },
               {
                "name": "noAvailabilityZoneSupport",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Warning",
                  "text": "Availability zones are not available in the region chosen on the Basics menu."
                },
                "visible": "[not(contains(first(filter(steps('basics').locationInfoApi.value, (item) => equals(item.name, location()))), 'availabilityZoneMappings'))]"
              },
              {
                "name": "defineAvailabilityZones",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable availability zones",
                "toolTip": "Configure availability zones to enforce file-system and compute resource proximity",
                "constraints": {
                  "required": false
                },
                "visible": "[contains(first(filter(steps('basics').locationInfoApi.value, (item) => equals(item.name, location()))), 'availabilityZoneMappings')]"
               },
              {
                "name": "SKUNotSelectedWarning",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Error",
                  "text": "All virtual machine sizes must be set in the Partition Settings menu before configuring availability zones."
                },
                "visible": "[and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize)), contains(first(filter(steps('basics').locationInfoApi.value, (item) => equals(item.name, location()))), 'availabilityZoneMappings'))]"
              },
              {
                "name": "sharedNetAppAvailabilityZone",
                "type": "Microsoft.Common.DropDown",
                "label": "Primary Azure NetApp Files",
                "multiselect": false,
                "toolTip": "Availability zone for the primary Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": "[if(contains(steps('basics').anfAvailabilityZonesApi.properties, 'availabilityZoneMappings'), map(filter(parse('[\"1\",\"2\",\"3\"]'), (item) => contains(map(filter(steps('basics').anfAvailabilityZonesApi.properties.availabilityZoneMappings, (item) => item.isAvailable), (item) => item.availabilityZone),item)), (zone) => parse(concat('{\"label\":\"', 'Zone ',zone, '\",\"value\":\"', zone, '\"}'))), parse('[{\"label\":\"No Availability Zone Support\",\"value\":\"null\"}]'))]",
                  "required": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
              },
              {
                "name": "additionalLustreAvailabilityZone",
                "type": "Microsoft.Common.DropDown",
                "label": "Additional Azure Managed Lustre",
                "multiselect": false,
                "toolTip": "Availability zone for the additional Azure Managed Lustre volume",
                "constraints": {
                  "allowedValues": "[if(equals(length(first(first(filter(steps('basics').amlAvailabilityZonesApi.value, (item) => equals(toLower(first(item.locations)), location()))).locationInfo).zones),0), parse('[{\"label\":\"No Availability Zone Support\",\"value\":\"null\"}]'), map(filter(parse('[\"1\",\"2\",\"3\"]'), (item) => contains(first(first(filter(steps('basics').amlAvailabilityZonesApi.value, (item) => equals(toLower(first(item.locations)), location()))).locationInfo).zones, item)), (item) => parse(concat('{\"label\":\"','Zone ',item,'\",\"value\":\"',item,'\"}'))))]",
                  "required": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "additionalNetAppAvailabilityZone",
                "type": "Microsoft.Common.DropDown",
                "label": "Additional Azure NetApp Files",
                "multiselect": false,
                "toolTip": "Availability zone for the additional Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": "[if(contains(steps('basics').anfAvailabilityZonesApi.properties, 'availabilityZoneMappings'), map(filter(parse('[\"1\",\"2\",\"3\"]'), (item) => contains(map(filter(steps('basics').anfAvailabilityZonesApi.properties.availabilityZoneMappings, (item) => item.isAvailable), (item) => item.availabilityZone),item)), (zone) => parse(concat('{\"label\":\"', 'Zone ',zone, '\",\"value\":\"', zone, '\"}'))), parse('[{\"label\":\"No Availability Zone Support\",\"value\":\"null\"}]'))]",
                  "required": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "computeNodeAZWarning",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Warning",
                  "text": "Ensure that the availability zones chosen for the compute nodes are the same as those set for new or existing file-system resources. Mismatch of availability zones may cause performance degredation due to increased latency."
                },
                "visible": "[and(not(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize)), contains(first(filter(steps('basics').locationInfoApi.value, (item) => equals(item.name, location()))), 'availabilityZoneMappings'))),steps('advancedSettings').availabilityzone.defineAvailabilityZones)]"
              },
              {
                "name": "htcZone",
                "type": "Microsoft.Common.DropDown",
                "label": "HTC partition nodes",
                "toolTip": "Availability zone for the HTC partition nodes",
                "placeholder": "Select an Availability Zone",
                "constraints": {
                  "allowedValues": "[if(lessOrEquals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones),1), parse(concat('[{\"label\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones),0),'No Availability Zone Support',concat('Zone ', first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones))),'\",\"value\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones),0),'',first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones)),'\"}]')), map(filter(parse('[\"not\",\"1\",\"2\",\"3\"]'), (item) => or(equals(item, 'not'),contains(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones,item))), (item) => parse(concat('{\"label\":\"',if(equals(item,'not'), 'No preference', concat('Zone ',item)),'\",\"value\":\"',if(equals(item,'not'), 'NA', item),'\"}'))))]",
                  "required": true
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones)]"
              },
              {
                "name": "hpcZone",
                "type": "Microsoft.Common.DropDown",
                "label": "HPC partition nodes",
                "toolTip": "Availability zone for the HPC partition nodes",
                "placeholder": "Select an Availability Zone",
                "constraints": {
                  "allowedValues": "[if(lessOrEquals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HPCSection.vmsize))).locationInfo).zones),1), parse(concat('[{\"label\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HPCSection.vmsize))).locationInfo).zones),0),'No Availability Zone Support',concat('Zone ', first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones))),'\",\"value\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HPCSection.vmsize))).locationInfo).zones),0),'',first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones)),'\"}]')), map(filter(parse('[\"not\",\"1\",\"2\",\"3\"]'), (item) => or(equals(item, 'not'),contains(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones,item))), (item) => parse(concat('{\"label\":\"',if(equals(item,'not'), 'No preference', concat('Zone ',item)),'\",\"value\":\"',if(equals(item,'not'), 'NA', item),'\"}'))))]",
                  "required": true
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones)]"
              },
              {
                "name": "gpuZone",
                "type": "Microsoft.Common.DropDown",
                "label": "GPU partition nodes",
                "placeholder": "Select an Availability Zone",
                "toolTip": "Availability zone for the GPU partition nodes",
                "constraints": {
                  "allowedValues": "[if(lessOrEquals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').GPUSection.vmsize))).locationInfo).zones),1), parse(concat('[{\"label\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').GPUSection.vmsize))).locationInfo).zones),0),'No Availability Zone Support',concat('Zone ', first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones))),'\",\"value\":\"',if(equals(length(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').GPUSection.vmsize))).locationInfo).zones),0),'',first(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones)),'\"}]')), map(filter(parse('[\"not\",\"1\",\"2\",\"3\"]'), (item) => or(equals(item, 'not'),contains(first(first(filter(steps('advancedSettings').availabilityzone.skuZoneInfo.value, (item) => equals(item.name, steps('slurmSettings').HTCSection.vmsize))).locationInfo).zones,item))), (item) => parse(concat('{\"label\":\"',if(equals(item,'not'), 'No preference', concat('Zone ',item)),'\",\"value\":\"',if(equals(item,'not'), 'NA', item),'\"}'))))]",
                  "required": true
                },
                "visible": "[and(not(or(empty(steps('slurmSettings').HTCSection.vmsize),empty(steps('slurmSettings').HPCSection.vmsize),empty(steps('slurmSettings').GPUSection.vmsize))),steps('advancedSettings').availabilityzone.defineAvailabilityZones)]"
              }
            ]
          },
                    {
            "name": "monitoringSection",
            "type": "Microsoft.Common.Section",
            "label": "Monitoring",
            "elements": [
              {
                "name": "monitoringInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Optionally deploy monitoring agents & sidecars with an ingestion endpoint for data collection authorization."
                }
              },
              {
                "name": "monitoringEnabled",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable monitoring",
                "toolTip": "Deploy monitoring agents and enable data collection",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "monitoringInstructions",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[steps('advancedSettings').monitoringSection.monitoringEnabled]",
                "options": {
                  "text": "Review the linked document to learn how to create the monitoring infrastructure suitable for Azure CycleCloud.",
                  "uri": "https://github.com/Azure/cyclecloud-monitoring/blob/1.0.4/README.md"
                }
              },
              {
                "name": "monitoringIngestionEndpoint",
                "type": "Microsoft.Common.TextBox",
                "label": "Monitoring ingestion endpoint",
                "toolTip": "Ingestion endpoint URL for Azure Monitor workspace",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^https?:\\/\\/[^\\/]+\\.[^\\/]+\\.metrics\\.ingest\\.monitor\\.azure\\.(com|us)\\/dataCollectionRules\\/[^\\/]+\\/streams\\/Microsoft-PrometheusMetrics\\/api\\/v1\\/write\\?api-version=\\d{4}-\\d{2}-\\d{2}$",
                      "message": "Must be a valid monitoring ingestion endpoint URL"
                    }
                  ]
                },
                "visible": "[steps('advancedSettings').monitoringSection.monitoringEnabled]"
              },
              {
                "name": "dataCollectionRule",
                "type": "Microsoft.Common.TextBox",
                "label": "Data collection rules",
                "toolTip": "Resource ID of the data collection rule for the Azure Monitor workspace instance",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^/subscriptions/[0-9a-fA-F-]{36}/resourceGroups/[A-Za-z0-9_-]+/providers/Microsoft\\.Insights/dataCollectionRules/[A-Za-z0-9_-]+$",
                      "message": "Must be a valid data collection rule resource ID"
                    }
                  ]
                },
                "visible": "[steps('advancedSettings').monitoringSection.monitoringEnabled]"
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "tags",
        "label": "Tags",
        "elements": [
          {
            "name": "tagsByResource",
            "type": "Microsoft.Common.TagsByResource",
            "toolTip": "Select resource tags",
            "resources": [
              "Microsoft.Storage/storageAccounts",
              "Microsoft.Compute/virtualMachines",
              "Microsoft.Network/networkInterfaces",
              "Microsoft.Network/virtualNetworks",
              "Microsoft.Network/networkSecurityGroups",
              "Microsoft.Network/natGateways",
              "Microsoft.StorageCache/amlFileSystems",
              "Microsoft.NetApp/netAppAccounts",
              "Microsoft.Network/bastionHosts",
              "Resource group",
              "Node Array",
              "Microsoft.ManagedIdentity/userAssignedIdentities"
            ]
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "adminUsername": "[basics('adminUser')]",
      "adminPassword": "[basics('adminPasswordBox')]",
      "adminSshPublicKey": "[if(equals(basics('autogeneratePasswordsAndKeys'),'entered'),basics('adminSshPublicKey'),basics('nullValue'))]",
      "storedKey": "[if(equals(basics('autogeneratePasswordsAndKeys'),'stored'),basics('keySelector'),basics('nullValue'))]",
      "ccVMName": "[basics('CycleCloudVmName')]",
      "ccVMSize": "[basics('CycleCloudVmSize')]",
      "resourceGroup": "[if(equals(basics('newexisting'),'existing'),first(split(basics('rgExisting'),'~')),basics('rgNew'))]",
      "entraIdInfo": {
        "type": "[if(basics('enableEntra'),'enabled','disabled')]",
        "tenantId": "[if(basics('enableEntra'),basics('tenantId'),basics('nullValue'))]",
        "clientId": "[if(basics('enableEntra'),basics('clientId'),basics('nullValue'))]",
        "managedIdentityId": "[if(basics('enableEntra'),basics('entraManagedIdentity').id,basics('nullValue'))]"
      },
      "sharedFilesystem": {
        "type": "[concat(if(equals(steps('filesystem').shared.newexisting,'new'),steps('filesystem').shared.filertype,'nfs'),'-',steps('filesystem').shared.newexisting)]",
        "nfsCapacityInGb": "[if(equals(steps('filesystem').shared.filertype,'nfs'),int(steps('filesystem').shared.nfscapacity),basics('nullValue'))]",
        "anfServiceTier": "[if(equals(steps('filesystem').shared.filertype,'anf'),steps('filesystem').shared.anftier,basics('nullValue'))]",
        "anfCapacityInTiB": "[if(equals(steps('filesystem').shared.filertype,'anf'),int(steps('filesystem').shared.anfcapacity),basics('nullValue'))]",
        "ipAddress": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.ipAddress,basics('nullValue'))]",
        "exportPath": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.exportPath,basics('nullValue'))]",
        "mountOptions": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.mountOptions,basics('nullValue'))]",
        "availabilityZone": "[if(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').shared.newexisting,'new'),equals(steps('filesystem').shared.filertype,'anf')),parse(concat('[\"', steps('advancedSettings').availabilityzone.sharedNetAppAvailabilityZone, '\"]')),basics('nullValue'))]"
      },
      "additionalFilesystem": {
        "type": "[if(steps('filesystem').additionalCheck.checkbox,concat(steps('filesystem').additional.filertype,'-',steps('filesystem').additional.newexisting),'disabled')]",
        "anfServiceTier": "[if(equals(steps('filesystem').additional.filertype,'anf'),steps('filesystem').additional.anftier,basics('nullValue'))]",
        "anfCapacityInTiB": "[if(equals(steps('filesystem').additional.filertype,'anf'),int(steps('filesystem').additional.anfcapacity),basics('nullValue'))]",
        "lustreTier": "[if(equals(steps('filesystem').additional.filertype,'aml'),steps('filesystem').additional.lustretier,basics('nullValue'))]",
        "lustreCapacityInTib": "[if(equals(steps('filesystem').additional.filertype,'aml'),int(steps('filesystem').additional.azurelustrecapacity),basics('nullValue'))]",
        "ipAddress": "[if(equals(steps('filesystem').additional.newexisting,'existing'),if(equals(steps('filesystem').additional.filertype,'aml'),steps('filesystem').additional.ipAddressAml,steps('filesystem').additional.ipAddressNfs),basics('nullValue'))]",
        "mountPath": "[if(steps('filesystem').additionalCheck.checkbox, steps('filesystem').additional.mountPath, basics('nullValue'))]",
        "exportPath": "[if(or(and(equals(steps('filesystem').additional.filertype, 'anf'),equals(steps('filesystem').additional.newexisting,'existing')),and(equals(steps('filesystem').additional.filertype, 'nfs'),equals(steps('filesystem').additional.newexisting,'existing'))), steps('filesystem').additional.exportPath,basics('nullValue'))]",
        "mountOptions": "[if(and(steps('filesystem').additionalCheck.checkbox,equals(steps('filesystem').additional.newexisting,'existing')),if(equals(steps('filesystem').additional.filertype,'aml'),steps('filesystem').additional.mountOptionsAml,steps('filesystem').additional.mountOptionsNfs), basics('nullValue'))]",
        "availabilityZone": "[if(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,equals(steps('filesystem').additional.newexisting,'new')),if(equals(steps('filesystem').additional.filertype,'aml'),parse(concat('[\"', steps('advancedSettings').availabilityzone.additionalLustreAvailabilityZone, '\"]')),parse(concat('[\"', steps('advancedSettings').availabilityzone.additionalNetAppAvailabilityZone, '\"]'))),if(and(not(steps('advancedSettings').availabilityzone.defineAvailabilityZones),equals(steps('filesystem').additional.newexisting,'new'),contains(first(filter(steps('basics').locationInfoApi.value, (item) => equals(item.name, location()))), 'availabilityZoneMappings'), equals(steps('filesystem').additional.filertype,'aml')),parse('[\"1\"]'),basics('nullValue')))]"
      },
      "network": {
        "type": "[steps('networking').newexisting]",
        "name": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.networkSelector.name)]",
        "addressSpace": "[if(equals(steps('networking').newexisting,'new'),concat(steps('networking').networkSettings.baseIpAddress,steps('networking').networkSettings.cidrPrefix),basics('nullValue'))]",
        "id": "[if(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.networkSelector.id,basics('nullValue'))]",
        "cyclecloudSubnet": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.ccsubnet)]",
        "computeSubnet": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.computesubnet)]",
        "sharedFilerSubnet": "[if(equals(steps('filesystem').shared.filertype,'anf'),if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.filersubnet1),basics('nullValue'))]",
        "additionalFilerSubnet": "[if(and(steps('filesystem').additionalCheck.checkbox,equals(steps('filesystem').additional.newexisting,'new')),if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.filersubnet2),basics('nullValue'))]",
        "bastion": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.bastion,basics('nullValue'))]",
        "createNatGateway": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.natgateway,basics('nullValue'))]",
        "vnetToPeer": "[if(steps('networking').networkSettings.peering,steps('networking').networkSettings.vnetPeeredVnetSelector,basics('nullValue'))]",
        "peeringAllowGatewayTransit": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.gateway,basics('nullValue'))]"
      },
      "storagePrivateDnsZone": {
        "type": "[if(equals(steps('networking').newexisting,'new'),'new',steps('networking').dnsZone.newExisting)]",
        "id": "[if(and(equals(steps('networking').newexisting,'new'),equals(steps('networking').dnsZone.newExisting,'new')),basics('nullValue'),steps('networking').dnsZone.dnsZoneSelector.id)]",
        "vnetLink": "[if(or(equals(steps('networking').newexisting,'new'),equals(steps('networking').dnsZone.newExisting,'new')),basics('nullValue'),if(not(equals(length(filter(steps('networking').dnsZone.vnetLinkProvidersApi.value, (item) => equals(item.properties.virtualNetwork.id,steps('networking').networkSettings.networkSelector.id))),1)),steps('networking').vnetLink.createVnetLink,false))]"
      },
      "databaseAdminPassword": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.databaseAdminPassword,basics('nullValue'))]",
      "databaseConfig": {
        "type": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.dbConnection,'disabled')]",
        "databaseUser": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.databaseUser,basics('nullValue'))]",
        "fqdn": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'fqdn'),steps('scheduler').schedulerSection.databaseURL,basics('nullValue'))]",
        "privateIp": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'privateIp'),steps('scheduler').schedulerSection.databasePIP,basics('nullValue'))]",
        "dbInfo": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'privateEndpoint'),steps('scheduler').schedulerSection.dbSelector,basics('nullValue'))]"
      },
      "clusterName": "[steps('scheduler').clusterSettings.clusterName]",
      "acceptMarketplaceTerms": "[steps('scheduler').clusterSettings.acceptMarketplaceTerms]",
      "slurmSettings": {
        "startCluster": "[steps('scheduler').clusterSettings.startCluster]",
        "version": "[steps('scheduler').schedulerSection.slurmVersion]",
        "healthCheckEnabled": "[steps('scheduler').clusterSettings.healthCheck]"
      },
      "schedulerNode": {
        "sku": "[steps('scheduler').schedulerSection.vmsize]",
        "osImage": "[if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName)]"
      },
      "loginNodes": {
        "sku": "[steps('scheduler').loginNodesSection.vmsize]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('scheduler').loginNodesSection.ImageName,'custom'),steps('scheduler').loginNodesSection.customImageName,steps('scheduler').loginNodesSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "initialNodes": "[int(steps('scheduler').loginNodesSection.initialNodes)]",
        "maxNodes": "[int(steps('scheduler').loginNodesSection.maxNodes)]"
      },
      "htc": {
        "sku": "[steps('slurmSettings').HTCSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').HTCSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').HTCSection.ImageName,'custom'),steps('slurmSettings').HTCSection.customImageName,steps('slurmSettings').HTCSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "useSpot": "[steps('slurmSettings').HTCSection.spotHTC]",
        "availabilityZone": "[if(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,not(contains(steps('advancedSettings').availabilityzone.htcZone,'NA'))),parse(concat('[\"',steps('advancedSettings').availabilityzone.htcZone,'\"]')),basics('nullValue'))]"
      },
      "hpc": {
        "sku": "[steps('slurmSettings').HPCSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').HPCSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').HPCSection.ImageName,'custom'),steps('slurmSettings').HPCSection.customImageName,steps('slurmSettings').HPCSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "availabilityZone": "[if(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,not(contains(steps('advancedSettings').availabilityzone.hpcZone,'NA'))),parse(concat('[\"',steps('advancedSettings').availabilityzone.hpcZone,'\"]')),basics('nullValue'))]"
      },
      "gpu": {
        "sku": "[steps('slurmSettings').GPUSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').GPUSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').GPUSection.ImageName,'custom'),steps('slurmSettings').GPUSection.customImageName,steps('slurmSettings').GPUSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "availabilityZone": "[if(and(steps('advancedSettings').availabilityzone.defineAvailabilityZones,not(contains(steps('advancedSettings').availabilityzone.gpuZone,'NA'))),parse(concat('[\"',steps('advancedSettings').availabilityzone.gpuZone,'\"]')),basics('nullValue'))]"
      },
      "ood": {
        "type": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),'enabled','disabled')]",
        "startCluster": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),if(not(equals(steps('ood').OODSection.registerEntraIDApp,'manual')),steps('ood').OODSection.startCluster,false),basics('nullValue'))]",
        "sku": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),steps('ood').OODSection.vmsize,basics('nullValue'))]",
        "osImage": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),if(equals(steps('ood').OODSection.ImageName,'custom'),steps('ood').OODSection.customImageName,steps('ood').OODSection.ImageName),basics('nullValue'))]",
        "userDomain": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),steps('ood').OODSection.userDomain,basics('nullValue'))]",
        "fqdn": "[if(not(equals(steps('ood').OODSection.fqdn,'')),steps('ood').OODSection.fqdn,basics('nullValue'))]",
        "registerEntraIDApp": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),equals(steps('ood').OODSection.registerEntraIDApp,'autoregister'),basics('nullValue'))]",
        "appTenantId": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),basics('tenantId'),basics('nullValue'))]",
        "appId": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),basics('clientId'),basics('nullValue'))]",
        "appManagedIdentityId": "[if(and(steps('ood').OODSection.deployOOD,basics('enableEntra')),basics('entraManagedIdentity').id,basics('nullValue'))]"
      },
      "monitoring": {
        "type": "[if(steps('advancedSettings').monitoringSection.monitoringEnabled,'enabled','disabled')]",
        "ingestionEndpoint": "[if(steps('advancedSettings').monitoringSection.monitoringEnabled,steps('advancedSettings').monitoringSection.monitoringIngestionEndpoint,basics('nullValue'))]",
        "dcrId": "[if(steps('advancedSettings').monitoringSection.monitoringEnabled,steps('advancedSettings').monitoringSection.dataCollectionRule,basics('nullValue'))]"
      },
      "tags": "[steps('tags').tagsByResource]"
    }
  }
}