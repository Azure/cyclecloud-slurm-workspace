{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "basics": {
        "description": "Version **2025.02.06**: [Release Notes](https://learn.microsoft.com/azure/cyclecloud/release-notes/ccws/release-notes)",
        "resourceGroup": {
          "visible": false
        },
        "location": {
          "label": "Region in which to deploy resources",
          "toolTip": "Select the region in which to deploy resources",
          "visible": true
        }
      }
    },
    "basics": [
      {
        "name": "rgApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/resourcegroups?api-version=2021-04-01')]"
        }
      },
      {
        "name": "newexisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group options",
        "defaultValue": "Create a new resource group",
        "toolTip": "Create a new resource group or use an existing one",
        "constraints": {
          "allowedValues": [
            {
              "label": "Create a new resource group",
              "value": "new"
            },
            {
              "label": "Use an existing resource group",
              "value": "existing"
            }
          ],
          "required": true
        },
        "visible": true
      },
      {
        "name": "rgExisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group",
        "toolTip": "Select or search for an existing resource group in selected region",
        "filter": true,
        "constraints": {
          "allowedValues": "[map(filter(basics('rgApi').value, (item) => equals(item.location,location())), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'existing')]"
      },
      {
        "name": "rgNew",
        "type": "Microsoft.Common.TextBox",
        "label": "Resource group",
        "toolTip": "Resource will be created in region selected above",
        "constraints": {
          "validations": [
            {
              "regex": "^(?!.*\\.$)[a-zA-Z0-9_().-À-ÖØ-öø-ſ]?[a-zA-Z0-9_().-À-ÖØ-öø-ſ]{0,88}$",
              "message": "Resource group names may only include alphanumeric, underscore, parentheses, hyphens, and periods (except at end)."
            }
          ],
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'new')]"
      },
      {
        "name": "CycleCloudVmName",
        "type": "Microsoft.Common.TextBox",
        "label": "CycleCloud VM Name",
        "defaultValue": "ccw-cyclecloud-vm",
        "toolTip": "Name for the CycleCloud VM",
        "constraints": {
          "required": true,
          "validations": [
            {
              "regex": "^[a-zA-Z0-9.-]{1,64}$",
              "message": "Azure Linux VM names must be between 1 and 64 characters long and contain only letters, numbers, '.', and '-'."
            },
            {
              "regex": "^(?![.-])(.*)(?<![.-])$",
              "message": "Azure resource names may neither begin nor end with '.' or '-'."
            }
          ]
        },
        "visible": true
      },
      {
        "name": "CycleCloudVmSize",
        "type": "Microsoft.Compute.SizeSelector",
        "label": "CycleCloud VM Size",
        "toolTip": "Select a size for the CycleCloud VM",
        "recommendedSizes": [
          "Standard_D4as_v5",
          "Standard_D4as_v4"
        ],
        "constraints": {
          "excludedSizes": [
            "Standard_D16pds_v5",
            "Standard_D16pds_v6",
            "Standard_D16plds_v5",
            "Standard_D16plds_v6",
            "Standard_D16pls_v5",
            "Standard_D16pls_v6",
            "Standard_D16ps_v5",
            "Standard_D16ps_v6",
            "Standard_D2pds_v5",
            "Standard_D2pds_v6",
            "Standard_D2plds_v5",
            "Standard_D2plds_v6",
            "Standard_D2pls_v5",
            "Standard_D2pls_v6",
            "Standard_D2ps_v5",
            "Standard_D2ps_v6",
            "Standard_D32pds_v5",
            "Standard_D32pds_v6",
            "Standard_D32plds_v5",
            "Standard_D32plds_v6",
            "Standard_D32pls_v5",
            "Standard_D32pls_v6",
            "Standard_D32ps_v5",
            "Standard_D32ps_v6",
            "Standard_D48pds_v5",
            "Standard_D48pds_v6",
            "Standard_D48plds_v5",
            "Standard_D48plds_v6",
            "Standard_D48pls_v5",
            "Standard_D48pls_v6",
            "Standard_D48ps_v5",
            "Standard_D48ps_v6",
            "Standard_D4pds_v5",
            "Standard_D4pds_v6",
            "Standard_D4plds_v5",
            "Standard_D4plds_v6",
            "Standard_D4pls_v5",
            "Standard_D4pls_v6",
            "Standard_D4ps_v5",
            "Standard_D4ps_v6",
            "Standard_D64pds_v5",
            "Standard_D64pds_v6",
            "Standard_D64plds_v5",
            "Standard_D64plds_v6",
            "Standard_D64pls_v5",
            "Standard_D64pls_v6",
            "Standard_D64ps_v5",
            "Standard_D64ps_v6",
            "Standard_D8pds_v5",
            "Standard_D8pds_v6",
            "Standard_D8plds_v5",
            "Standard_D8plds_v6",
            "Standard_D8pls_v5",
            "Standard_D8pls_v6",
            "Standard_D8ps_v5",
            "Standard_D8ps_v6",
            "Standard_D96pds_v6",
            "Standard_D96plds_v6",
            "Standard_D96pls_v6",
            "Standard_D96ps_v6",
            "Standard_E16pds_v5",
            "Standard_E16pds_v6",
            "Standard_E16ps_v5",
            "Standard_E16ps_v6",
            "Standard_E20pds_v5",
            "Standard_E20ps_v5",
            "Standard_E2pds_v5",
            "Standard_E2pds_v6",
            "Standard_E2ps_v5",
            "Standard_E2ps_v6",
            "Standard_E32pds_v5",
            "Standard_E32pds_v6",
            "Standard_E32ps_v5",
            "Standard_E32ps_v6",
            "Standard_E48pds_v6",
            "Standard_E48ps_v6",
            "Standard_E4pds_v5",
            "Standard_E4pds_v6",
            "Standard_E4ps_v5",
            "Standard_E4ps_v6",
            "Standard_E64pds_v6",
            "Standard_E64ps_v6",
            "Standard_E8pds_v5",
            "Standard_E8pds_v6",
            "Standard_E8ps_v5",
            "Standard_E8ps_v6",
            "Standard_E96pds_v6",
            "Standard_E96ps_v6",
            "Standard_A1_v2",
            "Standard_A2_v2",
            "Standard_A2m_v2",
            "Standard_A4_v2",
            "Standard_A4m_v2",
            "Standard_A8_v2",
            "Standard_A8m_v2",
            "Standard_D1",
            "Standard_D11",
            "Standard_D11_v2",
            "Standard_D12",
            "Standard_D12_v2",
            "Standard_D13",
            "Standard_D13_v2",
            "Standard_D14",
            "Standard_D14_v2",
            "Standard_D15_v2",
            "Standard_D16_v3",
            "Standard_D1_v2",
            "Standard_D2",
            "Standard_D2_v2",
            "Standard_D2_v3",
            "Standard_D3",
            "Standard_D32_v3",
            "Standard_D3_v2",
            "Standard_D4",
            "Standard_D48_v3",
            "Standard_D4_v2",
            "Standard_D4_v3",
            "Standard_D5_v2",
            "Standard_D64_v3",
            "Standard_D8_v3",
            "Standard_E16_v3",
            "Standard_E20_v3",
            "Standard_E2_v3",
            "Standard_E32_v3",
            "Standard_E48_v3",
            "Standard_E4_v3",
            "Standard_E64_v3",
            "Standard_E64i_v3",
            "Standard_E8_v3",
            "Standard_F1",
            "Standard_F16",
            "Standard_F2",
            "Standard_F4",
            "Standard_F8"
          ]
        },
        "options": {
          "hideDiskTypeFilter": true
        },
        "osPlatform": "Linux",
        "visible": true
      },
      {
        "name": "adminUser",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin User",
        "defaultValue": "hpcadmin",
        "toolTip": "Local admin user for the Virtual Machines",
        "constraints": {
          "required": true,
          "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$",
          "validationMessage": "Enter a valid username"
        },
        "visible": true
      },
      {
        "name": "adminPasswordBox",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "Admin Password",
          "confirmPassword": "Confirm password"
        },
        "toolTip": "The Admin User password",
        "constraints": {
          "required": true,
          "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
          "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      },
      {
        "name": "autogeneratePasswordsAndKeys",
        "type": "Microsoft.Common.DropDown",
        "label": "SSH public key source",
        "defaultValue": "Use existing public key",
        "toolTip": "Public keys can be entered manually or retrieved from an Azure Public Key resource",
        "constraints": {
          "allowedValues": [
            {
              "label": "Use existing public key",
              "value": "entered"
            },
            {
              "label": "Use key stored in Azure",
              "value": "stored"
            }
          ],
          "required": true
        }
      },
      {
        "name": "adminSshPublicKey",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin SSH Public Key",
        "toolTip": "SSH Public Key for the Virtual Machines",
        "constraints": {
          "required": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]",
          "regex": "^ssh-[a-zA-Z0-9]+ [A-Za-z0-9+/=]+(?: .*)?$",
          "validationMessage": "Invalid SSH public key"
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]"
      },
      {
        "name": "keySelector",
        "type": "Microsoft.Solutions.ResourceSelector",
        "label": "Select stored SSH key",
        "toolTip": "Select a stored SSH public key",
        "resourceType": "Microsoft.Compute/sshPublicKeys",
        "options": {
          "filter": {
            "subscription": "onBasics"
          }
        },
        "constraints": {
          "required": true,
          "validationMessage": "Please select a stored SSH key."
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'stored')]"
      },
      {
        "name": "nullValue",
        "type": "Microsoft.Common.CheckBox",
        "label": "Null Value",
        "toolTip": "Null Value",
        "defaultValue": false,
        "visible": false
      }
    ],
    "steps": [
      {
        "name": "filesystem",
        "label": "File-system",
        "subLabel": {
          "preValidation": "Configure your home directory settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Filesystem Settings",
        "elements": [
          {
            "name": "anfCheck",
            "type": "Microsoft.Common.Section",
            "label": "Azure NetApp Files",
            "elements": [
              {
                "name": "anfInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "PLACEHOLDER: INFORMATION ABOUT ANF"
                }
              },
              {
                "name": "checkbox",
                "type": "Microsoft.Common.CheckBox",
                "label": "Provision Azure NetApp Files",
                "toolTip": "Deploy an instance of Azure NetApp Files alongside Azure CycleCloud",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "anf",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Warning",
                  "text": "NetApp Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "anftier",
                "type": "Microsoft.Common.DropDown",
                "label": "Service Level",
                "defaultValue": "Premium",
                "multiselect": false,
                "toolTip": "Service level for the Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard",
                      "value": "Standard"
                    },
                    {
                      "label": "Premium",
                      "value": "Premium"
                    },
                    {
                      "label": "Ultra",
                      "value": "Ultra"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "anfcapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the Azure NetApp Files volume",
                "subLabel": "TiB",
                "defaultValue": "4",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              }
            ],
            "visible": "[steps('filesystem').anfCheck.checkbox]"
          },
          {
            "name": "lustreCheck",
            "type": "Microsoft.Common.Section",
            "label": "Azure Managed Lustre",
            "elements": [
              {
                "name": "additionalInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "PLACEHOLDER: INFORMATION ABOUT LUSTRE"
                }
              },
              {
                "name": "checkbox",
                "type": "Microsoft.Common.CheckBox",
                "label": "Provision Azure Managed Lustre",
                "toolTip": "Deploy an instance of Azure Managed Lustre alongside Azure CycleCloud",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "lustre",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "lustretier",
                "type": "Microsoft.Common.DropDown",
                "label": "Lustre Tier",
                "defaultValue": "AMLFS-Durable-Premium-250",
                "multiselect": false,
                "toolTip": "Select the Azure Manage Lustre SKU to use",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "AMLFS-Durable-Premium-40",
                      "description": "40 MB/s/TB, 48TB size increment",
                      "value": "AMLFS-Durable-Premium-40"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-125",
                      "description": "125 MB/s/TB, 16TB size increment",
                      "value": "AMLFS-Durable-Premium-125"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-250",
                      "description": "250 MB/s/TB, 8TB size increment",
                      "value": "AMLFS-Durable-Premium-250"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-500",
                      "description": "500 MB/s/TB, 4TB size increment",
                      "value": "AMLFS-Durable-Premium-500"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "azurelustrecapacity",
                "type": "Microsoft.Common.Slider",
                "min": "[int(if(endsWith(steps('filesystem').lustre.lustretier,'-40'),48,if(endsWith(steps('filesystem').lustre.lustretier,'-125'),16,if(endsWith(steps('filesystem').lustre.lustretier,'-250'),8,4))))]",
                "max": "[int(if(endsWith(steps('filesystem').lustre.lustretier,'-40'),768,128))]",
                "step": "[int(if(endsWith(steps('filesystem').lustre.lustretier,'-40'),48,if(endsWith(steps('filesystem').lustre.lustretier,'-125'),16,if(endsWith(steps('filesystem').lustre.lustretier,'-250'),8,4))))]",
                "label": "Capacity",
                "subLabel": "TiB",
                "defaultValue": 48,
                "showStepMarkers": true,
                "toolTip": "Capacity of the Azure Managed Lustre volume",
                "constraints": {
                  "required": true
                },
                "visible": true
              },
              {
                "name": "mountPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount path",
                "defaultValue": "/data",
                "toolTip": "Mount path for the additional filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": true
              }
            ],
            "visible": "[steps('filesystem').lustreCheck.checkbox]"
          }
        ]
      },
      {
        "name": "networking",
        "label": "Networking",
        "elements": [
          {
            "name": "infobox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optionally automatically create virtual network resources or use existing ones for the Azure CycleCloud deployment.\n\nPlease note that private endpoint, DNS zone, DNS zone group, and virtual network link resources will be created to establish network connectivity with the storage account that will be concurrently deployed for use by CycleCloud."
            }
          },
          {
            "name": "newexisting",
            "type": "Microsoft.Common.DropDown",
            "label": "Virtual network options",
            "defaultValue": "Automatically create new virtual network and subnets",
            "toolTip": "Auto-create new networking resources or use an existing virtual network and subnets",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Automatically create new virtual network and subnets",
                  "value": "new"
                },
                {
                  "label": "Use existing virtual network and subnets",
                  "value": "existing"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "networkSettings",
            "type": "Microsoft.Common.Section",
            "label": "Network configuration",
            "elements": [
              {
                "name": "lustreInfoBoxNew",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('filesystem').lustreCheck.checkbox,equals(steps('networking').newexisting,'new'))]",
                "options": {
                  "icon": "Warning",
                  "text": "The minimum CIDR required to deploy a new instance of Azure Managed Lustre is /23.\n\nThe option to create a new virtual network with a CIDR of /24 is therefore omitted in the below menu."
                }
              },
              {
                "name": "cidrPrefix",
                "type": "Microsoft.Common.DropDown",
                "label": "CIDR Prefix",
                "defaultValue": "[if(steps('filesystem').lustreCheck.checkbox,'/23','/24')]",
                "multiLine": true,
                "toolTip": "Select the CIDR prefix",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(steps('filesystem').lustreCheck.checkbox,'','/24')]",
                      "description": "[if(steps('filesystem').lustreCheck.checkbox,'','123 compute nodes')]",
                      "value": "[if(steps('filesystem').lustreCheck.checkbox,'','/24')]"
                    },
                    {
                      "label": "/23",
                      "description": "251 compute nodes",
                      "value": "/23"
                    },
                    {
                      "label": "/22",
                      "description": "506 compute nodes",
                      "value": "/22"
                    },
                    {
                      "label": "/21",
                      "description": "1019 compute nodes",
                      "value": "/21"
                    },
                    {
                      "label": "/20",
                      "description": "2043 compute nodes",
                      "value": "/20"
                    }
                  ],
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "baseIpAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "Base IP Address",
                "defaultValue": "10.0.0.0",
                "toolTip": "The base IP address for the IP range",
                "multiLine": false,
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "networkSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Virtual network",
                "toolTip": "Select existing virtual network",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "subNetProvidersApi",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(substring(steps('networking').networkSettings.networkSelector.id,0,length(steps('networking').networkSettings.networkSelector.id)),'/subnets?api-version=2024-05-01')]"
                }
              },
              {
                "name": "ccsubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "CycleCloud subnet",
                "toolTip": "Select subnet for CycleCloud",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "computesubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Compute node subnet",
                "toolTip": "Select subnet for compute nodes",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('filesystem').anfCheck.checkbox, equals(steps('networking').newexisting,'existing'))]",
                "options": {
                  "icon": "Warning",
                  "text": "Please confirm that the subnet selected below has the required Microsoft.NetApp/volumes delegation configured\nas specified in the Azure CycleCloud Workspace for Slurm documentation to ensure expected behavior.\n\nThe relevant official documentation may be viewed in a new browser tab by clicking on this box.",
                  "uri": "https://learn.microsoft.com/azure/cyclecloud/how-to/ccws/plan-your-deployment?view=cyclecloud-8#brownfield-deployment"
                }
              },
              {
                "name": "anfSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Azure NetApp Files subnet",
                "toolTip": "Select subnet for Azure NetApp Files",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(steps('filesystem').anfCheck.checkbox, equals(steps('networking').newexisting,'existing'))]"
              },
              {
                "name": "lustreInfoBoxExisting",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(steps('filesystem').lustreCheck.checkbox,equals(steps('networking').newexisting,'existing'))]",
                "options": {
                  "icon": "Warning",
                  "text": "The minimum CIDR required to deploy a new instance of Azure Managed Lustre is /23.\n\nPlease ensure that the subnet selected below meets this requirement."
                }
              },
              {
                "name": "lustreSubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Azure Managed Lustre subnet",
                "toolTip": "Select subnet for Azure Managed Lustre",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'existing'),steps('filesystem').lustreCheck.checkbox)]"
              },
              {
                "name": "bastion",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a Bastion for SSH connections",
                "toolTip": "Deploy an Azure Bastion for SSH connections",
                "defaultValue": false,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "natgateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a NAT Gateway",
                "toolTip": "Create a NAT Gateway for outbound traffic",
                "defaultValue": true,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "peering",
                "type": "Microsoft.Common.CheckBox",
                "label": "Peer to an existing virtual network",
                "defaultValue": false,
                "toolTip": "Enable peering to your existing virtual network",
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "vnetPeeredVnetSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select virtual network for peering",
                "toolTip": "Network must be in the same subscription",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              },
              {
                "name": "gateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow gateway transit",
                "defaultValue": false,
                "toolTip": "Enable if peering VNet has a gateway",
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "ood",
        "label": "Open OnDemand",
        "elements": [
          {
            "name": "OODSection",
            "type": "Microsoft.Common.Section",
            "label": "Open OnDemand",
            "elements": [
              {
                "name": "oodInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": true,
                "options": {
                  "icon": "Info",
                  "text": "Open OnDemand is an open-source, web-based portal developed by the Ohio Supercomputer Center (OSC) to provide easy access to high-performance computing (HPC) resources. This platform allows users to submit and monitor jobs, manage files, and run applications from anywhere, using just a web browser. The portal is designed to simplify the user experience, making it accessible for both novice and experienced HPC users."
                }
              },
              {
                "name": "deployOOD",
                "type": "Microsoft.Common.CheckBox",
                "label": "Deploy Open OnDemand",
                "toolTip": "Deploy Open OnDemand alongside the Slurm cluster",
                "defaultValue": true,
                "constraints": {
                  "required": false
                },
                "visible": true
              },
              {
                "name": "oodLoginNodeInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(and(steps('scheduler').makeCluster,steps('ood').OODSection.deployOOD),equals(int(steps('scheduler').loginNodesSection.initialNodes),0))]",
                "options": {
                  "icon": "Warning",
                  "text": "Open OnDemand for Azure CycleCloud requires a minimum of one login node for use as a proxy between Azure CycleCloud and the Open OnDemand web server. Please review selections made under the Slurm Cluster menu."
                }
              },
              {
                "name": "oodFilesystemInfo",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(and(steps('scheduler').makeCluster,steps('ood').OODSection.deployOOD),not(equals(steps('filesystem').shared.filertype,'anf')))]",
                "options": {
                  "icon": "Info",
                  "text": "Open OnDemand for Azure CycleCloud is best deployed with Azure NetApp Files used as the file-system for the /shared and /home directories."
                }
              },
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Open OnDemand VM Size",
                "toolTip": "Select a SKU for the Open OnDemand VM",
                "recommendedSizes": [
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": "[steps('ood').OODSection.deployOOD]"
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the OOD virtual machine",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8",
                      "value": "almalinux:almalinux-x86_64:8-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[steps('ood').OODSection.deployOOD]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('ood').OODSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('ood').OODSection.ImageName,'custom')]"
              },
              {
                "name": "userDomain",
                "type": "Microsoft.Common.TextBox",
                "label": "User domain",
                "defaultValue": "contoso.com",
                "toolTip": "Domain of user email addresses",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]+\\.[a-zA-Z]{2,}$",
                  "validationMessage": "Enter a valid domain name"
                },
                "visible": "[steps('ood').OODSection.deployOOD]"
              },
              {
                "name": "fqdn",
                "type": "Microsoft.Common.TextBox",
                "label": "FQDN",
                "defaultValue": "",
                "toolTip": "FQDN for the Open OnDemand web server",
                "constraints": {
                  "required": false,
                  "regex": "^[a-zA-Z0-9-]+\\.[a-zA-Z]{2,}$",
                  "validationMessage": "Enter a valid FQDN or leave blank"
                },
                "visible": "[steps('ood').OODSection.deployOOD]"
              },
              {
                "name": "registerEntraIDApp",
                "type": "Microsoft.Common.CheckBox",
                "label": "Register an Entra ID Application",
                "toolTip": "Register an Entra ID Application for Open OnDemand authentication using OpenID Connect",
                "defaultValue": true,
                "constraints": {
                  "required": false
                },
                "visible": "[steps('ood').OODSection.deployOOD]"
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "tags",
        "label": "Tags",
        "elements": [
          {
            "name": "tagsByResource",
            "type": "Microsoft.Common.TagsByResource",
            "toolTip": "Select resource tags",
            "resources": [
              "Microsoft.Storage/storageAccounts",
              "Microsoft.Compute/virtualMachines",
              "Microsoft.Network/networkInterfaces",
              "Microsoft.Network/virtualNetworks",
              "Microsoft.Network/networkSecurityGroups",
              "Microsoft.Network/natGateways",
              "Microsoft.StorageCache/amlFileSystems",
              "Microsoft.NetApp/netAppAccounts",
              "Microsoft.Network/bastionHosts",
              "Resource group",
              "Node Array",
              "Microsoft.ManagedIdentity/userAssignedIdentities"
            ]
          }
        ]
      }
    ],
    "outputs": {}
  }
}