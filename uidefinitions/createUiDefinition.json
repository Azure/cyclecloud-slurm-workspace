{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "basics": {
        "description": "Version **2024.12.18**: [Release Notes](https://learn.microsoft.com/azure/cyclecloud/release-notes/ccws/release-notes)",
        "resourceGroup": {
          "visible": false
        },
        "location": {
          "label": "Region in which to deploy resources",
          "toolTip": "Select the region in which to deploy resources",
          "visible": true
        }
      }
    },
    "basics": [
      {
        "name": "rgApi",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "GET",
          "path": "[concat(subscription().id,'/resourcegroups?api-version=2021-04-01')]"
        }
      },
      {
        "name": "newexisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group options",
        "defaultValue": "Create a new resource group",
        "toolTip": "Create a new resource group or use an existing one",
        "constraints": {
          "allowedValues": [
            {
              "label": "Create a new resource group",
              "value": "new"
            },
            {
              "label": "Use an existing resource group",
              "value": "existing"
            }
          ],
          "required": true
        },
        "visible": true
      },
      {
        "name": "rgExisting",
        "type": "Microsoft.Common.DropDown",
        "label": "Resource group",
        "toolTip": "Select or search for an existing resource group in selected region",
        "filter": true,
        "constraints": {
          "allowedValues": "[map(filter(basics('rgApi').value, (item) => equals(item.location,location())), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'existing')]"
      },
      {
        "name": "rgNew",
        "type": "Microsoft.Common.TextBox",
        "label": "Resource group",
        "toolTip": "Resource will be created in region selected above",
        "constraints": {
          "validations": [
            {
              "regex": "^(?!.*\\.$)[a-zA-Z0-9_().-À-ÖØ-öø-ſ]?[a-zA-Z0-9_().-À-ÖØ-öø-ſ]{0,88}$",
              "message": "Resource group names may only include alphanumeric, underscore, parentheses, hyphens, and periods (except at end)."
            }
          ],
          "required": true
        },
        "visible": "[equals(basics('newexisting'),'new')]"
      },
      {
        "name": "CycleCloudVmSize",
        "type": "Microsoft.Compute.SizeSelector",
        "label": "CycleCloud VM Size",
        "toolTip": "Select a size for the CycleCloud VM",
        "recommendedSizes": [
          "Standard_D4as_v4"
        ],
        "options": {
          "hideDiskTypeFilter": true
        },
        "osPlatform": "Linux",
        "visible": true
      },
      {
        "name": "adminUser",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin User",
        "defaultValue": "hpcadmin",
        "toolTip": "Local admin user for the Virtual Machines",
        "constraints": {
          "required": true,
          "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$",
          "validationMessage": "Enter a valid username"
        },
        "visible": true
      },
      {
        "name": "adminPasswordBox",
        "type": "Microsoft.Common.PasswordBox",
        "label": {
          "password": "Admin Password",
          "confirmPassword": "Confirm password"
        },
        "toolTip": "The Admin User password",
        "constraints": {
          "required": true,
          "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
          "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
        },
        "options": {
          "hideConfirmation": false
        },
        "visible": true
      },
      {
        "name": "autogeneratePasswordsAndKeys",
        "type": "Microsoft.Common.DropDown",
        "label": "SSH public key source",
        "defaultValue": "Use existing public key",
        "toolTip": "Public keys can be entered manually or retrieved from an Azure Public Key resource",
        "constraints": {
          "allowedValues": [
            {
              "label": "Use existing public key",
              "value": "entered"
            },
            {
              "label": "Use key stored in Azure",
              "value": "stored"
            }
          ],
          "required": true
        }
      },
      {
        "name": "adminSshPublicKey",
        "type": "Microsoft.Common.TextBox",
        "label": "Admin SSH Public Key",
        "toolTip": "SSH-RSA Public Key for the Virtual Machines",
        "constraints": {
          "required": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]",
          "regex": "^ssh-rsa AAAAB3NzaC1yc2[0-9A-Za-z+/]+[=]{0,3}(\\s.*)?$",
          "validationMessage": "Invalid ssh-rsa public key"
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'entered')]"
      },
      {
        "name": "keySelector",
        "type": "Microsoft.Solutions.ResourceSelector",
        "label": "Select stored SSH key",
        "toolTip": "Select a stored SSH public key",
        "resourceType": "Microsoft.Compute/sshPublicKeys",
        "options": {
          "filter": {
            "subscription": "onBasics"
          }
        },
        "constraints": {
          "required": true,
          "validationMessage": "Please select a stored SSH key."
        },
        "visible": "[equals(basics('autogeneratePasswordsAndKeys'),'stored')]"
      },
      {
        "name": "nullValue",
        "type": "Microsoft.Common.CheckBox",
        "label": "Null Value",
        "toolTip": "Null Value",
        "defaultValue": false,
        "visible": false
      }
    ],
    "steps": [
      {
        "name": "filesystem",
        "label": "File-system",
        "subLabel": {
          "preValidation": "Configure your home directory settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Filesystem Settings",
        "elements": [
          {
            "name": "shared",
            "type": "Microsoft.Common.Section",
            "label": "File-system mount for /shared and /home",
            "elements": [
              {
                "name": "sharedInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "The directory /shared is a network attached mount and exists in all nodes of the cluster. Users' home directories reside within this mountpoint with the base homedir /shared/home."
                }
              },
              {
                "name": "newexisting",
                "type": "Microsoft.Common.DropDown",
                "label": "Create new file-system",
                "defaultValue": "Create new",
                "toolTip": "Create new file-system type or use existing for /shared directory",
                "multiselect": false,
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Create new",
                      "value": "new"
                    },
                    {
                      "label": "Use existing external NFS",
                      "value": "existing"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "filertype",
                "type": "Microsoft.Common.DropDown",
                "label": "File-system Type",
                "defaultValue": "[if(equals(steps('filesystem').shared.newexisting,'new'),'Builtin NFS','External NFS')]",
                "toolTip": "Filer type for the /shared directory",
                "multiselect": false,
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(equals(steps('filesystem').shared.newexisting,'new'),'Builtin NFS','External NFS')]",
                      "value": "nfs"
                    },
                    {
                      "label": "Azure NetApp Files",
                      "value": "anf"
                    }
                  ],
                  "required": true
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'new')]"
              },
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('filesystem').shared.filertype,'anf')]",
                "options": {
                  "icon": "Warning",
                  "text": "NetApp Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "anfInfoBoxSlurmHA",
                "type": "Microsoft.Common.InfoBox",
                "visible": false,
                "options": {
                  "icon": "Warning",
                  "text": "Slurm High Availability will be unavailable in Slurm Settings with this choice of file-system."
                }
              },
              {
                "name": "anftier",
                "type": "Microsoft.Common.DropDown",
                "label": "Service Level",
                "defaultValue": "Premium",
                "multiselect": false,
                "toolTip": "Service level for the Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard",
                      "value": "Standard"
                    },
                    {
                      "label": "Premium",
                      "value": "Premium"
                    },
                    {
                      "label": "Ultra",
                      "value": "Ultra"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
              },
              {
                "name": "anfcapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the Azure NetApp Files volume",
                "subLabel": "TiB",
                "defaultValue": "4",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": "[and(equals(steps('filesystem').shared.filertype,'anf'),equals(steps('filesystem').shared.newexisting,'new'))]"
              },
              {
                "name": "nfscapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the NFS volume",
                "subLabel": "GB",
                "defaultValue": "1024",
                "constraints": {
                  "required": true,
                  "regex": "^(100|10[0-1]\\d{3}|[1-9]\\d{2}|[1-9]\\d{3}|[1-9]\\d{4}|102400)$",
                  "validationMessage": "Please enter an integer between 100 and 102400"
                },
                "visible": "[and(equals(steps('filesystem').shared.newexisting,'new'),equals(steps('filesystem').shared.filertype,'nfs'))]"
              },
              {
                "name": "ipAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "IP Address",
                "toolTip": "IP address of the filer mount",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              },
              {
                "name": "exportPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Export path",
                "defaultValue": "/shared",
                "toolTip": "Export path for the primary filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              },
              {
                "name": "mountOptions",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount options",
                "defaultValue": "rw,hard,rsize=262144,wsize=262144,vers=3,tcp,_netdev",
                "toolTip": "Mount options for the primary filer",
                "constraints": {
                  "required": false,
                  "regex": "^.+$",
                  "validationMessage": "Please enter a mount option"
                },
                "visible": "[equals(steps('filesystem').shared.newexisting,'existing')]"
              }
            ],
            "visible": true
          },
          {
            "name": "additionalCheck",
            "type": "Microsoft.Common.Section",
            "label": "Additional file-system mount",
            "elements": [
              {
                "name": "additionalInfo",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Optionally mount another endpoint on the cluster nodes."
                }
              },
              {
                "name": "checkbox",
                "type": "Microsoft.Common.CheckBox",
                "label": "Add another file-system mount",
                "toolTip": "Add an additional filer",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "additional",
            "type": "Microsoft.Common.Section",
            "elements": [
              {
                "name": "newexisting",
                "type": "Microsoft.Common.DropDown",
                "label": "Create new file-system",
                "defaultValue": "Create new",
                "toolTip": "Create new file-system or use existing",
                "multiselect": false,
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Create new",
                      "value": "new"
                    },
                    {
                      "label": "Use existing",
                      "value": "existing"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "filertype",
                "type": "Microsoft.Common.DropDown",
                "label": "File-system Type",
                "defaultValue": "[if(equals(steps('filesystem').additional.newexisting,'new'),'Azure NetApp Files','External NFS')]",
                "toolTip": "File-system type",
                "multiselect": false,
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(equals(steps('filesystem').additional.newexisting,'new'),'Azure NetApp Files','External NFS')]",
                      "value": "[if(equals(steps('filesystem').additional.newexisting,'new'),'anf','nfs')]"
                    },
                    {
                      "label": "Azure Managed Lustre",
                      "value": "aml"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "anfInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('filesystem').additional.filertype,'anf')]",
                "options": {
                  "icon": "Warning",
                  "text": "NetApp Resource Provider must be registered for your subscription."
                }
              },
              {
                "name": "anfInfoBoxSlurmHA",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(false, equals(steps('filesystem').additional.filertype,'anf'))]",
                "options": {
                  "icon": "Warning",
                  "text": "Slurm High Availability will be unavailable in Slurm Settings with this choice of file-system."
                }
              },
              {
                "name": "anftier",
                "type": "Microsoft.Common.DropDown",
                "label": "Service Level",
                "defaultValue": "Premium",
                "multiselect": false,
                "toolTip": "Service level for the Azure NetApp Files volume",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard",
                      "value": "Standard"
                    },
                    {
                      "label": "Premium",
                      "value": "Premium"
                    },
                    {
                      "label": "Ultra",
                      "value": "Ultra"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "anfcapacity",
                "type": "Microsoft.Common.TextBox",
                "label": "Capacity",
                "toolTip": "Capacity of the Azure NetApp Files volume",
                "subLabel": "TiB",
                "defaultValue": "4",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'anf'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "lustretier",
                "type": "Microsoft.Common.DropDown",
                "label": "Lustre Tier",
                "defaultValue": "AMLFS-Durable-Premium-250",
                "multiselect": false,
                "toolTip": "Select the Azure Manage Lustre SKU to use",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "AMLFS-Durable-Premium-40",
                      "description": "40 MB/s/TB, 48TB size increment",
                      "value": "AMLFS-Durable-Premium-40"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-125",
                      "description": "125 MB/s/TB, 16TB size increment",
                      "value": "AMLFS-Durable-Premium-125"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-250",
                      "description": "250 MB/s/TB, 8TB size increment",
                      "value": "AMLFS-Durable-Premium-250"
                    },
                    {
                      "label": "AMLFS-Durable-Premium-500",
                      "description": "500 MB/s/TB, 4TB size increment",
                      "value": "AMLFS-Durable-Premium-500"
                    }
                  ],
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "azurelustrecapacity",
                "type": "Microsoft.Common.Slider",
                "min": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),48,if(endsWith(steps('filesystem').additional.lustretier,'-125'),16,if(endsWith(steps('filesystem').additional.lustretier,'-250'),8,4))))]",
                "max": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),768,128))]",
                "step": "[int(if(endsWith(steps('filesystem').additional.lustretier,'-40'),48,if(endsWith(steps('filesystem').additional.lustretier,'-125'),16,if(endsWith(steps('filesystem').additional.lustretier,'-250'),8,4))))]",
                "label": "Capacity",
                "subLabel": "TiB",
                "defaultValue": 48,
                "showStepMarkers": true,
                "toolTip": "Capacity of the Azure Managed Lustre volume",
                "constraints": {
                  "required": true
                },
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'))]"
              },
              {
                "name": "ipAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "IP Address",
                "toolTip": "IP address of the filer mount",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('filesystem').additional.newexisting,'existing')]"
              },
              {
                "name": "mountPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount path",
                "defaultValue": "/data",
                "toolTip": "Mount path for the additional filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": true
              },
              {
                "name": "exportPath",
                "type": "Microsoft.Common.TextBox",
                "label": "Export path",
                "defaultValue": "/mnt/data",
                "toolTip": "Export path for the additional filer",
                "constraints": {
                  "required": true,
                  "regex": "^\/(?:[\\w-.]+\/)*[\\w-.]+$",
                  "validationMessage": "Must be an absolute path"
                },
                "visible": "[and(equals(steps('filesystem').additional.newexisting, 'existing'),not(equals(steps('filesystem').additional.filertype,'aml')))]"
              },
              {
                "name": "mountOptions",
                "type": "Microsoft.Common.TextBox",
                "label": "Mount options",
                "defaultValue": "rw,hard,rsize=262144,wsize=262144,vers=3,tcp,_netdev",
                "toolTip": "Mount options for the additional filer",
                "constraints": {
                  "required": false,
                  "regex": "^.+$",
                  "validationMessage": "Please enter a mount option."
                },
                "visible": "[equals(steps('filesystem').additional.newexisting,'existing')]"
              }
            ],
            "visible": "[steps('filesystem').additionalCheck.checkbox]"
          }
        ]
      },
      {
        "name": "networking",
        "label": "Networking",
        "elements": [
          {
            "name": "infobox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optionally automatically create virtual network resources or use existing ones for the cluster deployment.\n\nIf proceeding with the latter, then please confirm that the chosen subnets have the necessary Service Endpoints and delegations as specified in the Azure CycleCloud Workspace for Slurm documentation to ensure expected behavior.\n\nThe relevant official documentation may be viewed in a new browser tab by clicking on this box.",
              "uri": "https://learn.microsoft.com/azure/cyclecloud/how-to/ccws/plan-your-deployment?view=cyclecloud-8#brownfield-deployment"
            }
          },
          {
            "name": "newexisting",
            "type": "Microsoft.Common.DropDown",
            "label": "Virtual network options",
            "defaultValue": "Automatically create new virtual network and subnets",
            "toolTip": "Auto-create new networking resources or use an existing virtual network and subnets",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Automatically create new virtual network and subnets",
                  "value": "new"
                },
                {
                  "label": "Use existing virtual network and subnets",
                  "value": "existing"
                }
              ],
              "required": true
            },
            "visible": true
          },
          {
            "name": "networkSettings",
            "type": "Microsoft.Common.Section",
            "label": "Network configuration",
            "elements": [
              {
                "name": "lustreInfoBoxNew",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),equals(steps('networking').newexisting,'new'))]",
                "options": {
                  "icon": "Warning",
                  "text": "The minimum CIDR required to deploy a new instance of Azure Managed Lustre is /23.\n\nThe option to create a new virtual network with a CIDR of /24 is therefore omitted in the below menu."
                  }
              },
              {
                "name": "lustreInfoBoxExisting",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new'),equals(steps('networking').newexisting,'existing'))]",
                "options": {
                  "icon": "Warning",
                  "text": "The minimum CIDR required to deploy a new instance of Azure Managed Lustre is /23.\n\nPlease ensure that the subnet for the additional file-system selected below meets this requirement."
                  }
              },
              {
                "name": "cidrPrefix",
                "type": "Microsoft.Common.DropDown",
                "label": "CIDR Prefix",
                "defaultValue": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'/23','/24')]",
                "multiLine": true,
                "toolTip": "Select the CIDR prefix",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','/24')]",
                      "description": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','123 compute nodes')]",
                      "value": "[if(and(equals(steps('filesystem').additional.filertype,'aml'),equals(steps('filesystem').additional.newexisting,'new')),'','/24')]"
                    },
                    {
                      "label": "/23",
                      "description": "251 compute nodes",
                      "value": "/23"
                    },
                    {
                      "label": "/22",
                      "description": "506 compute nodes",
                      "value": "/22"
                    },
                    {
                      "label": "/21",
                      "description": "1019 compute nodes",
                      "value": "/21"
                    },
                    {
                      "label": "/20",
                      "description": "2043 compute nodes",
                      "value": "/20"
                    }
                  ],
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "baseIpAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "Base IP Address",
                "defaultValue": "10.0.0.0",
                "toolTip": "The base IP address for the IP range",
                "multiLine": false,
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "networkSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select virtual network",
                "toolTip": "Select existing virtual network",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "subNetProvidersApi",
                "type": "Microsoft.Solutions.ArmApiControl",
                "request": {
                  "method": "GET",
                  "path": "[concat(substring(steps('networking').networkSettings.networkSelector.id,0,length(steps('networking').networkSettings.networkSelector.id)),'/subnets?api-version=2023-09-01')]"
                }
              },
              {
                "name": "ccsubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Select subnet for CycleCloud",
                "toolTip": "Select subnet for CycleCloud",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "computesubnet",
                "type": "Microsoft.Common.DropDown",
                "label": "Select subnet for compute nodes",
                "toolTip": "Select subnet for compute nodes",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[equals(steps('networking').newexisting,'existing')]"
              },
              {
                "name": "filersubnet1",
                "type": "Microsoft.Common.DropDown",
                "label": "Select subnet for primary file-system",
                "toolTip": "Select subnet for primary file-system",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(not(equals(steps('filesystem').shared.filertype, 'nfs')), equals(steps('networking').newexisting,'existing'))]"
              },
              {
                "name": "filersubnet2",
                "type": "Microsoft.Common.DropDown",
                "label": "Select subnet for additional file-system",
                "toolTip": "Select subnet for additional file-system",
                "constraints": {
                  "allowedValues": "[map(steps('networking').networkSettings.subNetProvidersApi.value, (item) => parse(concat('{\"label\":\"', item.name,' - ',item.properties.addressPrefix, '\",\"value\":\"', item.name, '\"}')))]",
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'existing'),steps('filesystem').additionalCheck.checkbox)]"
              },
              {
                "name": "bastion",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a Bastion for SSH connections",
                "toolTip": "Deploy an Azure Bastion for SSH connections",
                "defaultValue": false,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "natgateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Create a NAT Gateway",
                "toolTip": "Create a NAT Gateway for outbound traffic",
                "defaultValue": false,
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "peering",
                "type": "Microsoft.Common.CheckBox",
                "label": "Peer to an existing virtual network",
                "defaultValue": false,
                "toolTip": "Enable peering to your existing virtual network",
                "visible": "[equals(steps('networking').newexisting,'new')]"
              },
              {
                "name": "vnetPeeredVnetSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select virtual network for peering",
                "toolTip": "Network must be in the same subscription",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "constraints": {
                  "required": true
                },
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              },
              {
                "name": "gateway",
                "type": "Microsoft.Common.CheckBox",
                "label": "Allow gateway transit",
                "defaultValue": false,
                "toolTip": "Enable if peering VNet has a gateway",
                "visible": "[and(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.peering)]"
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "scheduler",
        "label": "Slurm Settings",
        "elements": [
          {
            "name": "clusterSettings",
            "type": "Microsoft.Common.Section",
            "label": "Cluster Configuration",
            "elements": [
              {
                "name": "acceptMarketplaceTerms",
                "type": "Microsoft.Common.CheckBox",
                "label": "Auto-accept VM image terms",
                "toolTip": "Enable CycleCloud to automatically accept any Azure Marketplace VM image terms for the selected Azure subscription",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "healthCheck",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable health check",
                "toolTip": "Enable health check scripts (NHC) to be run during allocation",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              },
              {
                "name": "clusterName",
                "type": "Microsoft.Common.TextBox",
                "label": "Cluster name",
                "defaultValue": "ccw",
                "toolTip": "Name of cluster in CycleCloud portal",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9@_-]{3,}$",
                  "validationMessage": "Cluster name must be at least 3 characters long. Characters must be alphanumeric, @, -, or _."
                },
                "visible": false
              }
            ],
            "visible": true
          },
          {
            "name": "schedulerSection",
            "type": "Microsoft.Common.Section",
            "label": "Scheduler",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a size for the Scheduler VM",
                "recommendedSizes": [
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the Login Nodes",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8.10",
                      "value": "almalinux:almalinux-hpc:8_10-hpc-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 20.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2004:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2204:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                }
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('scheduler').schedulerSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('scheduler').schedulerSection.ImageName,'custom')]"
              },
              {
                "name": "universalImage",
                "type": "Microsoft.Common.CheckBox",
                "label": "Use image on all nodes",
                "toolTip": "Use the indicated image on all nodes",
                "defaultValue": false,
                "visible": true
              },
              {
                "name": "slurmVersion",
                "type": "Microsoft.Common.DropDown",
                "label": "Slurm Version",
                "defaultValue": "24.05.4",
                "toolTip": "Select the version of Slurm to use",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "23.11.10",
                      "description": "Version 23.11.10",
                      "value": "23.11.10-2"
                    },
                    {
                      "label": "24.05.4",
                      "description": "Version 24.05.4",
                      "value": "24.05.4-2"
                    }
                  ],
                  "required": true
                },
                "visible": true
              },
              {
                "name": "slurmHA",
                "type": "Microsoft.Common.CheckBox",
                "label": "Slurm HA",
                "toolTip": "Select to enable Slurm High Availability",
                "defaultValue": false,
                "visible": false
              },
              {
                "name": "slurmAccounting",
                "type": "Microsoft.Common.CheckBox",
                "label": "Slurm job accounting",
                "toolTip": "Select to enable Slurm job accounting in a managed MySQL instance",
                "defaultValue": false,
                "visible": true
              },
              {
                "name": "databaseInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]",
                "options": {
                  "icon": "Warning",
                  "text": "CycleCloud Workspace for Slurm currently only supports job accounting in existing MySQL instances. \nPlease visit the linked page to create a new MySQL instance prior to launching CycleCloud Workspace for Slurm.",
                  "uri": "https://portal.azure.com/#create/Microsoft.MySQLServer"
                }
              },
              {
                "name": "databaseUser",
                "type": "Microsoft.Common.TextBox",
                "label": "Database user",
                "defaultValue": "hpcdbadmin",
                "toolTip": "Username of the Slurm accounting database admin",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z][a-zA-Z0-9_]{5,19}$",
                  "validationMessage": "Enter a valid username"
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "databaseAdminPassword",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Database Admin Password",
                  "confirmPassword": "Confirm Password"
                },
                "toolTip": "Password for the Slurm accounting database admin user",
                "constraints": {
                  "required": "[not(equals(basics('autogeneratePasswordsAndKeys'),1))]",
                  "regex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_\\-+=[\\]{}|\\\\:'\",.?`~\";]).{8,123}$",
                  "validationMessage": "Your password must contain at least 8 characters, including at least one uppercase letter, one lowercase letter, one number, and one special character (@ # $ % ^ & * - _ ! + = [ ] { } | \\ : ' , . ? ` ~ \" ( ) ; )"
                },
                "options": {
                  "hideConfirmation": false
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "dbConnection",
                "type": "Microsoft.Common.DropDown",
                "label": "Connection options",
                "defaultValue": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: FQDN',if(equals(steps('networking').newexisting,'new'),'Private Endpoint',''))]",
                "toolTip": "Select method by which to connect to the existing MySQL database",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: FQDN','')]",
                      "value": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'fqdn','')]"
                    },
                    {
                      "label": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'Direct: Private IP','')]",
                      "value": "[if(or(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.peering),'privateIp','')]"
                    },
                    {
                      "label": "[if(equals(steps('networking').newexisting,'new'),'Private Endpoint','')]",
                      "value": "[if(equals(steps('networking').newexisting,'new'),'privateEndpoint','')]"
                    }
                  ],
                  "required": true
                },
                "visible": "[steps('scheduler').schedulerSection.slurmAccounting]"
              },
              {
                "name": "databaseURL",
                "type": "Microsoft.Common.TextBox",
                "label": "Database FQDN (URL)",
                "defaultValue": ".mysql.database.azure.com",
                "toolTip": "Enter a FQDN (URL) for the MySQL database",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:http[s]?:\\/\\/.)?(?:www\\.)?[-a-zA-Z0-9@%._\\+~#=]{2,256}\\.[a-z]{2,6}\\b(?:[-a-zA-Z0-9@:%_\\+.~#?&\/\/=]*)$",
                      "message": "Please enter a valid MySQL database FQDN."
                    }
                  ]
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'fqdn')]"
              },
              {
                "name": "databasePIP",
                "type": "Microsoft.Common.TextBox",
                "label": "Database Private IP",
                "defaultValue": "",
                "toolTip": "Enter the private IP address of the MySQL database",
                "constraints": {
                  "required": true,
                  "validations": [
                    {
                      "regex": "^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$",
                      "message": "Invalid IP address"
                    }
                  ]
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'privateIp')]"
              },
              {
                "name": "dbSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Select MySQL Database",
                "toolTip": "Select a MySQL Flexible Server in the Azure region selected on the Basics page",
                "resourceType": "Microsoft.DBforMySQL/flexibleServers",
                "options": {
                  "filter": {
                    "subscription": "onBasics"
                  }
                },
                "constraints": {
                  "required": true,
                  "validationMessage": "Please select a MySQL Flexible Server."
                },
                "visible": "[equals(steps('scheduler').schedulerSection.dbConnection,'privateEndpoint')]"
              },
              {
                "name": "useLoginNodes",
                "type": "Microsoft.Common.CheckBox",
                "label": "Use login nodes",
                "toolTip": "Select to create login nodes for your cluster",
                "defaultValue": false,
                "visible": false
              }
            ]
          },
          {
            "name": "loginNodesSection",
            "type": "Microsoft.Common.Section",
            "label": "Login Nodes",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the Login nodes",
                "recommendedSizes": [
                  "Standard_F4s_v2"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the Login Nodes",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8.10",
                      "value": "almalinux:almalinux-hpc:8_10-hpc-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 20.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2004:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2204:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('scheduler').loginNodesSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('scheduler').loginNodesSection.ImageName,'custom')]"
              },
              {
                "name": "initialNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Initial number of login nodes",
                "defaultValue": "1",
                "toolTip": "Enter a number between 0 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[0-9]|[1-9][0-9]|[1-9][0-9][0-9]|1000)$",
                  "validationMessage": "Please enter an integer between 0 and 1000"
                },
                "visible": true
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Max number of nodes",
                "defaultValue": "1",
                "toolTip": "Enter a number between 1 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "slurmSettings",
        "label": "Partition Settings",
        "elements": [
          {
            "name": "infobox",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Slurm uses partitions to distinguish different execute node types. We provide 3 common use cases, High-Throughput Compute (HTC), CPU-based High-Performance Compute (HPC) and GPU-based HPC (GPU)."
            }
          },
          {
            "name": "HTCSection",
            "type": "Microsoft.Common.Section",
            "label": "HTC Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the HTC partition",
                "recommendedSizes": [
                  "Standard_F2s_v2"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Max number of nodes",
                "defaultValue": "100",
                "toolTip": "Enter an integer between 1 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the HTC partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8.10",
                      "value": "almalinux:almalinux-hpc:8_10-hpc-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 20.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2004:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2204:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').HTCSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').HTCSection.ImageName,'custom')]"
              },
              {
                "name": "spotHTC",
                "type": "Microsoft.Common.CheckBox",
                "label": "Enable Azure Spot",
                "toolTip": "Enable Azure Spot discount",
                "defaultValue": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "HPCSection",
            "type": "Microsoft.Common.Section",
            "label": "HPC Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the HPC partition",
                "recommendedSizes": [
                  "Standard_HB120rs_v3",
                  "Standard_HB176rs_v4",
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Max number of nodes",
                "defaultValue": "16",
                "toolTip": "Enter an integer between 1 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the HPC partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8.10",
                      "value": "almalinux:almalinux-hpc:8_10-hpc-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 20.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2004:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2204:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').HPCSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image ID or URN",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').HPCSection.ImageName,'custom')]"
              },
              {
                "name": "spotHPC",
                "label": "Enable Azure Spot",
                "type": "Microsoft.Common.CheckBox",
                "toolTip": "Enable Azure Spot discount",
                "defaultValue": false,
                "visible": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          },
          {
            "name": "GPUSection",
            "type": "Microsoft.Common.Section",
            "label": "GPU Partition",
            "elements": [
              {
                "name": "vmsize",
                "type": "Microsoft.Compute.SizeSelector",
                "label": "Size",
                "toolTip": "Select a VM Size for the GPU partition",
                "recommendedSizes": [
                  "Standard_ND96asr_v4",
                  "Standard_ND96amsr_A100_v4",
                  "Standard_NC24ads_A100_v4",
                  "Standard_ND96isr_H100_v5",
                  "Standard_D4as_v4"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "osPlatform": "Linux",
                "visible": true,
                "required": true,
                "validationMessage": "VMSize is required."
              },
              {
                "name": "maxNodes",
                "type": "Microsoft.Common.TextBox",
                "label": "Max number of nodes",
                "defaultValue": "8",
                "toolTip": "Enter an integer between 1 and 1000",
                "constraints": {
                  "required": true,
                  "regex": "^(?:[1-9]\\d{0,2}|1000)$",
                  "validationMessage": "Please enter an integer between 1 and 1000"
                },
                "visible": true
              },
              {
                "name": "ImageName",
                "type": "Microsoft.Common.DropDown",
                "label": "Image Name",
                "defaultValue": "Ubuntu 22.04",
                "toolTip": "Select the image to use for the GPU partition",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Alma Linux 8.10",
                      "value": "almalinux:almalinux-hpc:8_10-hpc-gen2:latest"
                    },
                    {
                      "label": "Ubuntu 20.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2004:latest"
                    },
                    {
                      "label": "Ubuntu 22.04",
                      "value": "microsoft-dsvm:ubuntu-hpc:2204:latest"
                    },
                    {
                      "label": "Custom image",
                      "value": "custom"
                    }
                  ],
                  "required": true,
                  "validationMessage": "Image Name is required."
                },
                "visible": "[not(steps('scheduler').schedulerSection.universalImage)]"
              },
              {
                "name": "customImageInfoBox",
                "type": "Microsoft.Common.InfoBox",
                "visible": "[equals(steps('slurmSettings').GPUSection.ImageName,'custom')]",
                "options": {
                  "icon": "Info",
                  "text": "Custom images may be used by entering a URN of an Azure Marketplace image or the resource ID of other custom images in the chosen subscription. Please ensure that inputs conform to the below formats for proper deployment.\n\nResource ID for an image in Azure Compute Gallery:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/galleries/{galleryName}/images/{imageName}/versions/{versionNumber}\n\nResource ID for a legacy managed image:\n/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute\n/images/{imageName}\n\nAzure Marketplace URN:\npublisher:offer:sku:version"
                }
              },
              {
                "name": "customImageName",
                "type": "Microsoft.Common.TextBox",
                "label": "Custom Image URN or ID",
                "defaultValue": "",
                "toolTip": "Enter a custom image URN or ID",
                "constraints": {
                  "required": true,
                  "regex": "^.{1,}$",
                  "validationMessage": "Please enter a custom image resource ID or URN"
                },
                "visible": "[equals(steps('slurmSettings').GPUSection.ImageName,'custom')]"
              },
              {
                "name": "spotGPU",
                "type": "Microsoft.Common.CheckBox",
                "toolTip": "Enable Azure Spot discount",
                "label": "Enable Azure Spot",
                "defaultValue": false,
                "visible": false,
                "constraints": {
                  "required": false
                }
              }
            ]
          }
        ]
      },
      {
        "name": "tags",
        "label": "Tags",
        "elements": [
          {
            "name": "tagsByResource",
            "type": "Microsoft.Common.TagsByResource",
            "toolTip": "Select resource tags",
            "resources": [
              "Microsoft.Storage/storageAccounts",
              "Microsoft.Compute/virtualMachines",
              "Microsoft.Network/networkInterfaces",
              "Microsoft.Network/virtualNetworks",
              "Microsoft.Network/networkSecurityGroups",
              "Microsoft.Network/natGateways",
              "Microsoft.StorageCache/amlFileSystems",
              "Microsoft.NetApp/netAppAccounts",
              "Microsoft.Network/bastionHosts",
              "Resource group",
              "Node Array",
              "Microsoft.ManagedIdentity/userAssignedIdentities"
            ]
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "adminUsername": "[basics('adminUser')]",
      "adminPassword": "[basics('adminPasswordBox')]",
      "adminSshPublicKey": "[if(equals(basics('autogeneratePasswordsAndKeys'),'entered'),basics('adminSshPublicKey'),basics('nullValue'))]",
      "storedKey": "[if(equals(basics('autogeneratePasswordsAndKeys'),'stored'),basics('keySelector'),basics('nullValue'))]",
      "ccVMSize": "[basics('CycleCloudVmSize')]",
      "resourceGroup": "[if(equals(basics('newexisting'),'existing'),first(split(basics('rgExisting'),'~')),basics('rgNew'))]",
      "sharedFilesystem": {
        "type": "[concat(if(equals(steps('filesystem').shared.newexisting,'new'),steps('filesystem').shared.filertype,'nfs'),'-',steps('filesystem').shared.newexisting)]",
        "nfsCapacityInGb": "[if(equals(steps('filesystem').shared.filertype,'nfs'),int(steps('filesystem').shared.nfscapacity),basics('nullValue'))]",
        "anfServiceTier": "[if(equals(steps('filesystem').shared.filertype,'anf'),steps('filesystem').shared.anftier,basics('nullValue'))]",
        "anfCapacityInTiB": "[if(equals(steps('filesystem').shared.filertype,'anf'),int(steps('filesystem').shared.anfcapacity),basics('nullValue'))]",
        "ipAddress": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.ipAddress,basics('nullValue'))]",
        "exportPath": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.exportPath,basics('nullValue'))]",
        "mountOptions": "[if(equals(steps('filesystem').shared.newexisting,'existing'),steps('filesystem').shared.mountOptions,basics('nullValue'))]"
      },
      "additionalFilesystem": {
        "type": "[if(steps('filesystem').additionalCheck.checkbox,concat(steps('filesystem').additional.filertype,'-',steps('filesystem').additional.newexisting),'disabled')]",
        "anfServiceTier": "[if(equals(steps('filesystem').additional.filertype,'anf'),steps('filesystem').additional.anftier,basics('nullValue'))]",
        "anfCapacityInTiB": "[if(equals(steps('filesystem').additional.filertype,'anf'),int(steps('filesystem').additional.anfcapacity),basics('nullValue'))]",
        "lustreTier": "[if(equals(steps('filesystem').additional.filertype,'aml'),steps('filesystem').additional.lustretier,basics('nullValue'))]",
        "lustreCapacityInTib": "[if(equals(steps('filesystem').additional.filertype,'aml'),int(steps('filesystem').additional.azurelustrecapacity),basics('nullValue'))]",
        "ipAddress": "[if(equals(steps('filesystem').additional.newexisting,'existing'),steps('filesystem').additional.ipAddress,basics('nullValue'))]",
        "mountPath": "[if(steps('filesystem').additionalCheck.checkbox, steps('filesystem').additional.mountPath, basics('nullValue'))]",
        "exportPath": "[if(or(and(equals(steps('filesystem').additional.filertype, 'anf'),equals(steps('filesystem').additional.newexisting,'existing')),and(equals(steps('filesystem').additional.filertype, 'nfs'),equals(steps('filesystem').additional.newexisting,'existing'))), steps('filesystem').additional.exportPath,basics('nullValue'))]",
        "mountOptions": "[if(steps('filesystem').additionalCheck.checkbox, steps('filesystem').additional.mountOptions, basics('nullValue'))]"
      },
      "network": {
        "type": "[steps('networking').newexisting]",
        "name": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.networkSelector.name)]",
        "addressSpace": "[if(equals(steps('networking').newexisting,'new'),concat(steps('networking').networkSettings.baseIpAddress,steps('networking').networkSettings.cidrPrefix),basics('nullValue'))]",
        "id": "[if(equals(steps('networking').newexisting,'existing'),steps('networking').networkSettings.networkSelector.id,basics('nullValue'))]",
        "cyclecloudSubnet": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.ccsubnet)]",
        "computeSubnet": "[if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.computesubnet)]",
        "sharedFilerSubnet": "[if(equals(steps('filesystem').shared.filertype,'anf'),if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.filersubnet1),basics('nullValue'))]",
        "additionalFilerSubnet": "[if(and(steps('filesystem').additionalCheck.checkbox,equals(steps('filesystem').additional.newexisting,'new')),if(equals(steps('networking').newexisting,'new'),basics('nullValue'),steps('networking').networkSettings.filersubnet2),basics('nullValue'))]",
        "bastion": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.bastion,basics('nullValue'))]",
        "createNatGateway": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.natgateway,basics('nullValue'))]",
        "vnetToPeer": "[if(steps('networking').networkSettings.peering,steps('networking').networkSettings.vnetPeeredVnetSelector,basics('nullValue'))]",
        "peeringAllowGatewayTransit": "[if(equals(steps('networking').newexisting,'new'),steps('networking').networkSettings.gateway,basics('nullValue'))]"
      },
      "databaseAdminPassword": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.databaseAdminPassword,basics('nullValue'))]",
      "databaseConfig": {
        "type": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.dbConnection,'disabled')]",
        "databaseUser": "[if(steps('scheduler').schedulerSection.slurmAccounting,steps('scheduler').schedulerSection.databaseUser,basics('nullValue'))]",
        "fqdn": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'fqdn'),steps('scheduler').schedulerSection.databaseURL,basics('nullValue'))]",
        "privateIp": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'privateIp'),steps('scheduler').schedulerSection.databasePIP,basics('nullValue'))]",
        "dbInfo": "[if(equals(steps('scheduler').schedulerSection.dbConnection,'privateEndpoint'),steps('scheduler').schedulerSection.dbSelector,basics('nullValue'))]"
      },
      "clusterName": "[steps('scheduler').clusterSettings.clusterName]",
      "acceptMarketplaceTerms": "[steps('scheduler').clusterSettings.acceptMarketplaceTerms]",
      "slurmSettings": {
        "version": "[steps('scheduler').schedulerSection.slurmVersion]",
        "healthCheckEnabled": "[steps('scheduler').clusterSettings.healthCheck]"
      },
      "schedulerNode": {
        "sku": "[steps('scheduler').schedulerSection.vmsize]",
        "osImage": "[if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName)]"
      },
      "loginNodes": {
        "sku": "[steps('scheduler').loginNodesSection.vmsize]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('scheduler').loginNodesSection.ImageName,'custom'),steps('scheduler').loginNodesSection.customImageName,steps('scheduler').loginNodesSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "initialNodes": "[int(steps('scheduler').loginNodesSection.initialNodes)]",
        "maxNodes": "[int(steps('scheduler').loginNodesSection.maxNodes)]"
      },
      "htc": {
        "sku": "[steps('slurmSettings').HTCSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').HTCSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').HTCSection.ImageName,'custom'),steps('slurmSettings').HTCSection.customImageName,steps('slurmSettings').HTCSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]",
        "useSpot": "[steps('slurmSettings').HTCSection.spotHTC]"
      },
      "hpc": {
        "sku": "[steps('slurmSettings').HPCSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').HPCSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').HPCSection.ImageName,'custom'),steps('slurmSettings').HPCSection.customImageName,steps('slurmSettings').HPCSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]"
      },
      "gpu": {
        "sku": "[steps('slurmSettings').GPUSection.vmsize]",
        "maxNodes": "[int(steps('slurmSettings').GPUSection.maxNodes)]",
        "osImage": "[if(not(steps('scheduler').schedulerSection.universalImage),if(equals(steps('slurmSettings').GPUSection.ImageName,'custom'),steps('slurmSettings').GPUSection.customImageName,steps('slurmSettings').GPUSection.ImageName),if(equals(steps('scheduler').schedulerSection.ImageName,'custom'),steps('scheduler').schedulerSection.customImageName,steps('scheduler').schedulerSection.ImageName))]"
      },
      "tags": "[steps('tags').tagsByResource]"
    }
  }
}